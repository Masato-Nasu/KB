<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Square Kaleidoscope â€” PWA + Chime + Music</title>

<link rel="manifest" href="./manifest.json?v=4">
<meta name="theme-color" content="#0f0f12">
<link rel="icon" href="./icon-192.png">
<link rel="apple-touch-icon" href="./icon-192.png">

<style>
  html,body{margin:0;height:100%;background:#000;overflow:hidden}
  #c{width:100vw;height:100vh;display:block;touch-action:manipulation}
  #ui{position:fixed;bottom:10px;left:50%;transform:translateX(-50%);
      display:flex;gap:10px;align-items:center;color:#fff;font-family:sans-serif;font-size:14px;flex-wrap:wrap;justify-content:center;z-index:3}
  input[type=file]{appearance:auto;background:#111;color:#fff;border:1px solid #444;border-radius:8px;padding:8px 12px}
  button{background:#111;border:1px solid #444;border-radius:8px;padding:8px 14px;cursor:pointer;color:#fff}
  #status{position:fixed;top:10px;left:50%;transform:translateX(-50%);color:#9cf;font-family:monospace;font-size:12px;opacity:.95;z-index:3;text-align:center;white-space:pre-wrap}
  #install{position:fixed;top:10px;right:10px}
  #dropHint{position:fixed;inset:auto auto 64px 50%;transform:translateX(-50%);color:#bbb;font:12px/1.4 sans-serif;z-index:3;opacity:.9}
</style>
</head>
<body>
<canvas id="c"></canvas>
<div id="status">bootingâ€¦</div>

<div id="ui">
  <!-- ç”»åƒ -->
  <input type="file" id="img" accept="image/*">
  <button id="reset" title="æ—¢å®šæ¨¡æ§˜ã«æˆ»ã™">ç”»åƒã‚¯ãƒªã‚¢</button>

  <!-- éŸ³ï¼ˆã‚»ãƒ³ã‚µãƒ¼ï¼†ãƒãƒ£ã‚¤ãƒ ï¼‰ -->
  <button id="enable">ğŸ”Š ã‚»ãƒ³ã‚µãƒ¼ã¨éŸ³ã‚’æœ‰åŠ¹åŒ–</button>

  <!-- éŸ³æ¥½ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼ -->
  <input type="file" id="music" accept="audio/*">
  <button id="play">â–¶ï¸ å†ç”Ÿ</button>

  <button id="install" hidden>+ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</button>
</div>
<div id="dropHint">ğŸ–¼ ç”»åƒã¯ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã§ã‚‚èª­ã¿è¾¼ã‚ã¾ã™</div>

<!-- ãƒãƒ£ã‚¤ãƒ ï¼š**å¤§æ–‡å­—Cã«çµ±ä¸€** -->
<audio id="chime" src="./Chime.m4a?v=4" preload="auto" playsinline></audio>
<!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼éŸ³æºãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼ -->
<audio id="player" preload="none" playsinline></audio>

<script>
/* ===== Service Worker ===== */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js?v=4').catch(e=>{
    document.getElementById('status').textContent = 'SWç™»éŒ²å¤±æ•—: '+e.message+'\n(https/localhostã§ã®ã¿æœ‰åŠ¹)';
  });
}

/* ===== PWA Install ===== */
let deferredPrompt;
const installBtn = document.getElementById('install');
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault(); deferredPrompt=e; installBtn.hidden=false;
});
installBtn.onclick = async () => {
  installBtn.hidden=true; if(deferredPrompt){ deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; }
};

/* ===== Canvas & 2D/GL ===== */
const canvas = document.getElementById('c'), statusEl = document.getElementById('status');
const dpr=Math.min(devicePixelRatio||1,2);
function fit(){ canvas.width=Math.floor(innerWidth*dpr); canvas.height=Math.floor(innerHeight*dpr); }
addEventListener('resize', fit); fit();

const ctx2d = canvas.getContext('2d');
function drawChecker2D(){
  const w=canvas.width,h=canvas.height,c=16,s=Math.ceil(Math.min(w,h)/c);
  for(let y=0;y<Math.ceil(h/s);y++)for(let x=0;x<Math.ceil(w/s);x++){
    ctx2d.fillStyle=((x+y)&1)?'#202020':'#505050'; ctx2d.fillRect(x*s,y*s,s,s);
  }
}
drawChecker2D();
statusEl.textContent='2D èµ·å‹• â€” WebGL åˆæœŸåŒ–ä¸­â€¦';

let gl, prog, tex=null, start=performance.now(), img2D=null;
function initGL(){
  const opts = {alpha:false,antialias:true};
  gl = canvas.getContext('webgl', opts) || canvas.getContext('experimental-webgl', opts);
  if(!gl) throw new Error('WebGL åˆæœŸåŒ–ã«å¤±æ•—ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶è¨­å®š/ç’°å¢ƒï¼‰');

  const vs=`attribute vec2 aPos;varying vec2 vUv;void main(){vUv=(aPos+1.0)*0.5;gl_Position=vec4(aPos,0.0,1.0);}`;
  const fs=`precision mediump float;varying vec2 vUv;uniform float uTime,uSectors,uHasTex;uniform sampler2D uTex;
  vec3 checker(vec2 uv){float s=16.0;vec2 c=floor(uv*s);float m=mod(c.x+c.y,2.0);float v=mix(0.32,0.10,m);return vec3(v);}
  void main(){vec2 uv=vUv-0.5;float r=length(uv);float a=atan(uv.y,uv.x);a=mod(a*uSectors/2.0, 3.14159265358979323846264);
  vec2 p=vec2(cos(a),sin(a))*r;float breathe=1.0+0.25*sin(uTime*0.8);vec2 t=p*breathe+0.5;
  vec3 col=(uHasTex>0.5)?texture2D(uTex,t).rgb:checker(t);gl_FragColor=vec4(col,1.0);}`;

  function sh(tp,src){
    const s=gl.createShader(tp); gl.shaderSource(s,src); gl.compileShader(s);
    if(!gl.getShaderParameter(s,gl.COMPILE_STATUS)) throw new Error('Shader compile: '+gl.getShaderInfoLog(s));
    return s;
  }
  const vsObj=sh(gl.VERTEX_SHADER,vs), fsObj=sh(gl.FRAGMENT_SHADER,fs);
  prog=gl.createProgram(); gl.attachShader(prog,vsObj); gl.attachShader(prog,fsObj); gl.linkProgram(prog);
  if(!gl.getProgramParameter(prog,gl.LINK_STATUS)) throw new Error('Program link: '+gl.getProgramInfoLog(prog));
  gl.useProgram(prog);

  const quad=new Float32Array([-1,-1, 1,-1, -1,1, 1,1]);
  const vbo=gl.createBuffer(); gl.bindBuffer(gl.ARRAY_BUFFER,vbo); gl.bufferData(gl.ARRAY_BUFFER,quad,gl.STATIC_DRAW);
  const loc=gl.getAttribLocation(prog,'aPos'); gl.enableVertexAttribArray(loc); gl.vertexAttribPointer(loc,2,gl.FLOAT,false,0,0);

  prog.uTime=gl.getUniformLocation(prog,'uTime');
  prog.uSectors=gl.getUniformLocation(prog,'uSectors');
  prog.uTex=gl.getUniformLocation(prog,'uTex');
  prog.uHasTex=gl.getUniformLocation(prog,'uHasTex');

  gl.uniform1f(prog.uSectors,16.0);
  gl.uniform1f(prog.uHasTex,0.0);
  gl.uniform1i(prog.uTex,0);
  gl.viewport(0,0,canvas.width,canvas.height);
  statusEl.textContent='WebGL åˆæœŸåŒ–OK â€” ç”»åƒæœªé¸æŠ';
}
function makeTextureFromImage(img){
  if(!gl){ img2D = img; statusEl.textContent='âœ… ç”»åƒãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼ˆ2Dãƒ¢ãƒ¼ãƒ‰ï¼‰'; return; }
  if(!tex) tex=gl.createTexture();
  gl.activeTexture(gl.TEXTURE0);
  gl.bindTexture(gl.TEXTURE_2D,tex);
  gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,true);
  gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,img);
  gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);
  gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);
  gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.REPEAT);
  gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.REPEAT);
  gl.uniform1f(prog.uHasTex,1.0);
  statusEl.textContent='âœ… ç”»åƒãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼ˆWebGLï¼‰';
}
function render(){
  const t=(performance.now()-start)/1000;
  if(gl){
    gl.viewport(0,0,canvas.width,canvas.height);
    gl.clearColor(0,0,0,1); gl.clear(gl.COLOR_BUFFER_BIT);
    gl.uniform1f(prog.uTime,t);
    gl.drawArrays(gl.TRIANGLE_STRIP,0,4);
  }else{
    // 2D ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šç”»åƒãŒã‚ã‚‹æ™‚ã¯ç°¡æ˜“ã€Œæ­£æ–¹å½¢ä¸‡è¯é¡é¢¨ã€ã«ã‚¿ã‚¤ãƒ«
    const w=canvas.width,h=canvas.height;
    ctx2d.clearRect(0,0,w,h);
    if(img2D){
      const scale=1.0+0.1*Math.sin(t*0.8);
      const tile = Math.max(128, Math.min(w,h)/4);
      for(let y=0;y<h;y+=tile){
        for(let x=0;x<w;x+=tile){
          ctx2d.save();
          // ã‚¿ã‚¤ãƒ«ã”ã¨ã«æ°´å¹³/å‚ç›´åè»¢ã—ã¦ä¸‡è¯é¡é¢¨
          if(((x/tile)|0)&1) ctx2d.scale(-1,1), ctx2d.translate(-x*2-tile,0);
          if(((y/tile)|0)&1) ctx2d.scale(1,-1), ctx2d.translate(0,-y*2-tile);
          const cw=tile*scale, ch=tile*scale;
          ctx2d.drawImage(img2D, x-(cw-tile)/2, y-(ch-tile)/2, cw, ch);
          ctx2d.restore();
        }
      }
    }else{
      drawChecker2D();
    }
  }
  requestAnimationFrame(render);
}
requestAnimationFrame(render);
try{ initGL(); }catch(e){
  statusEl.textContent='âš  WebGL åˆæœŸåŒ–ã«å¤±æ•—: '+e.message+'\n(https/localhostæ¨å¥¨ã€ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã‚¢ã‚¯ã‚»ãƒ©æœ‰åŠ¹ã€GPUåˆ¶é™è§£é™¤)';
}

/* ===== ç”»åƒ: ãƒœã‚¿ãƒ³ & D&D ===== */
const fileInput = document.getElementById('img');
document.getElementById('reset').onclick = ()=>{ img2D=null; if(gl && tex){ gl.uniform1f(prog.uHasTex,0.0); } statusEl.textContent='ç”»åƒã‚¯ãƒªã‚¢'; };
fileInput.addEventListener('change', (e)=>{
  const f=e.target.files && e.target.files[0]; if(!f) return;
  const url = URL.createObjectURL(f);
  const img = new Image();
  img.onload = ()=>{ makeTextureFromImage(img); URL.revokeObjectURL(url); };
  img.onerror = ()=>{ statusEl.textContent='âŒ ç”»åƒã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ'; };
  img.src = url;
});
let dragDepth = 0;
window.addEventListener('dragenter', e=>{e.preventDefault(); dragDepth++; statusEl.textContent='â‡© ã“ã“ã«ç”»åƒã‚’ãƒ‰ãƒ­ãƒƒãƒ—';});
window.addEventListener('dragover',  e=>{e.preventDefault();});
window.addEventListener('dragleave', e=>{e.preventDefault(); dragDepth=Math.max(0,dragDepth-1); if(!dragDepth) statusEl.textContent='ç¨¼åƒä¸­ â€” ç”»åƒã¯ãƒœã‚¿ãƒ³ã‹D&Dã§';});
window.addEventListener('drop', e=>{
  e.preventDefault(); dragDepth=0;
  const f = e.dataTransfer.files && e.dataTransfer.files[0];
  if(f && f.type.startsWith('image/')){
    const url = URL.createObjectURL(f);
    const img = new Image();
    img.onload = ()=>{ makeTextureFromImage(img); URL.revokeObjectURL(url); };
    img.onerror = ()=>{ statusEl.textContent='âŒ ç”»åƒã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ'; };
    img.src = url;
  }else{
    statusEl.textContent='â„¹ ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„';
  }
});

/* ===== ãƒãƒ£ã‚¤ãƒ ï¼šã‚¿ãƒƒãƒ—/ã‚·ã‚§ã‚¤ã‚¯ ===== */
const chimeEl = document.getElementById('chime');
let lastPlay = 0;
async function enableAudioSensors(){
  try{
    if (typeof DeviceMotionEvent!=='undefined' && typeof DeviceMotionEvent.requestPermission==='function'){
      try{ await DeviceMotionEvent.requestPermission(); }catch(e){}
    }
    try{ await chimeEl.play(); chimeEl.pause(); chimeEl.currentTime = 0; }catch(e){}
    statusEl.textContent='ğŸ”Š æœ‰åŠ¹åŒ–ï¼šã‚¿ãƒƒãƒ—/ã‚·ã‚§ã‚¤ã‚¯ã§ãƒãƒ£ã‚¤ãƒ ã€éŸ³æ¥½ã‚‚å†ç”Ÿå¯';
  }catch(err){
    statusEl.textContent='âŒ éŸ³ã®åˆæœŸåŒ–å¤±æ•—: '+err.message;
  }
}
document.getElementById('enable').onclick = enableAudioSensors;
function playChime(){
  const now=performance.now(); if(now-lastPlay<300) return; lastPlay=now;
  chimeEl.currentTime = 0; chimeEl.play().catch(()=>{});
}
canvas.addEventListener('pointerdown', playChime);
let lastA={x:0,y:0,z:0}, lastT=0;
window.addEventListener('devicemotion',(e)=>{
  const a=e.accelerationIncludingGravity||{x:0,y:0,z:0};
  const dx=a.x-lastA.x, dy=a.y-lastA.y, dz=a.z-lastA.z; lastA=a;
  const mag=Math.sqrt(dx*dx+dy*dy+dz*dz), t=performance.now();
  if(mag>18 && t-lastT>600){ lastT=t; playChime(); }
},{passive:true});

/* ===== éŸ³æ¥½ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼ ===== */
const musicInput = document.getElementById('music');
const player = document.getElementById('player');
const playBtn = document.getElementById('play');

musicInput.addEventListener('change', e=>{
  const f = e.target.files && e.target.files[0]; if(!f) return;
  const url = URL.createObjectURL(f);
  player.src = url;
  player.onloadedmetadata = ()=>{ statusEl.textContent='ğŸµ éŸ³æºèª­ã¿è¾¼ã¿å®Œäº†ï¼š' + (f.name||'audio'); };
});
playBtn.onclick = ()=>{
  if(!player.src){ statusEl.textContent='â„¹ å…ˆã«éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„'; return; }
  if(player.paused){ player.play().then(()=>{ playBtn.textContent='â¸ ä¸€æ™‚åœæ­¢'; }).catch(()=>{}); }
  else { player.pause(); playBtn.textContent='â–¶ï¸ å†ç”Ÿ'; }
};
</script>
</body>
</html>
