<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
<title>Baby Calm Kaleidoscope — Ultra Gentle</title>
<link rel="icon" href="./babyface-192.png" type="image/png" />
<style>
  html,body{height:100%;margin:0;overflow:hidden;background:#0a0a0d;color:#fff;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
  body{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:16px;gap:16px}
  canvas{width:100%;max-width:560px;aspect-ratio:1/1;background:#000;
    box-shadow:0 0 40px rgba(0,0,0,.6);opacity:0;transition:opacity .6s ease;pointer-events:none}
  canvas.active{opacity:1;pointer-events:auto}
  #controls{width:100%;max-width:560px;display:flex;flex-direction:column;gap:8px}
  #lcd,button,label,select{
    height:44px;border-radius:12px;background:#101015;border:1px solid #2e2e35;color:#fff;
    display:flex;align-items:center;justify-content:center;cursor:pointer;
    font-family:ui-monospace,Menlo,Consolas,monospace;font-size:15px;padding:0 12px}
  #lcd{overflow:hidden}
  #lcd span{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%}
  .row{display:flex;gap:8px}
  .row>*{flex:1}
  .opt{display:flex;gap:8px;align-items:center;justify-content:space-between}
  .opt input{transform:scale(1.2)}
  input[type=file],audio{display:none}
  .hint{opacity:.65;font-size:12px;text-align:center}
</style>
</head>
<body>
<canvas id="cv" width="560" height="560" title="Tap to gently spin & tint"></canvas>

<div id="controls">
  <div id="lcd"><span>NO IMAGE — CLICK “SELECT IMAGE”</span></div>

  <div class="row">
    <label id="imgBtn">SELECT IMAGE</label>
    <select id="sectorSel" title="Sectors"><option>8</option><option selected>12</option><option>16</option></select>
    <select id="ringSel" title="Rings"><option>3</option><option selected>5</option><option>7</option></select>
  </div>

  <div class="opt">
    <label class="optlabel">Baby Calm Mode</label>
    <input type="checkbox" id="calm" checked>
  </div>
  <div class="opt">
    <label class="optlabel">Enable Phone Shake (optional)</label>
    <input type="checkbox" id="enableShake">
  </div>

  <div class="hint">やさしくタップ → 模様がゆっくり45°回転＆色がふんわり変化します</div>
</div>

<audio id="chime" src="./Sparkling Chime Sound.m4a" preload="auto"></audio>

<script>
/* ===== Base ===== */
const cv=document.getElementById('cv'), ctx=cv.getContext('2d');
const W=cv.width, H=cv.height, CX=W/2, CY=H/2;
const R2=Math.hypot(CX,CY); // 四隅まで届く半径

const lcdSpan=document.querySelector('#lcd span');
const sectorSel=document.getElementById('sectorSel');
const ringSel=document.getElementById('ringSel');
const calmToggle=document.getElementById('calm');
const shakeToggle=document.getElementById('enableShake');
let sectors=+sectorSel.value, rings=+ringSel.value;
sectorSel.onchange=()=>sectors=+sectorSel.value;
ringSel.onchange=()=>rings=+ringSel.value;

/* ===== Image (cover) ===== */
const imgBtn=document.getElementById('imgBtn');
const imgInput=document.createElement('input'); imgInput.type='file'; imgInput.accept='image/*';
imgBtn.onclick=()=>imgInput.click();
let img=null,imgW=0,imgH=0,imgReady=false;
imgInput.onchange=e=>{
  const f=e.target.files?.[0]; if(!f) return;
  const u=URL.createObjectURL(f);
  img=new Image();
  img.onload=()=>{ imgW=img.naturalWidth; imgH=img.naturalHeight; imgReady=true;
    lcdSpan.textContent=`IMAGE: ${f.name}`; cv.classList.add('active'); URL.revokeObjectURL(u); };
  img.src=u;
};

/* ===== Offscreen（超おだやかモーション） ===== */
const off=document.createElement('canvas'), octx=off.getContext('2d');
off.width=off.height=Math.max(W,H)*2.2;

// 動きの係数（Calm on でさらに弱く）
function easeFactor(){
  let k = 1.0;
  if (calmToggle.checked) k *= 0.55; // ベビーモードで弱め
  if (matchMedia('(prefers-reduced-motion: reduce)').matches) k *= 0.6; // 端末設定に配慮
  return k;
}

function drawOff(t){
  if(!imgReady) return;
  const base=off.width;
  const coverS=Math.max(base/imgW, base/imgH);
  const k=easeFactor();

  // とてもゆっくり：パン幅と回転を小さく、周期も遅め
  const zoom = 1.04 + 0.02*Math.sin(t*0.18)*k;     // 微小ズーム
  const sw=imgW/(coverS*zoom), sh=imgH/(coverS*zoom);

  const ax=0.5+0.25*k*Math.sin(t*0.10);            // パン幅小
  const ay=0.5+0.25*k*Math.sin(t*0.13+1.1);
  const sx=(imgW-sw)*ax, sy=(imgH-sh)*ay;

  const rot = 0.005*k*Math.sin(t*0.12);            // 微小回転（~0.3°）

  octx.setTransform(1,0,0,1,0,0);
  octx.clearRect(0,0,base,base);
  octx.translate(base/2,base/2);
  octx.rotate(rot);
  octx.drawImage(img, sx,sy,sw,sh, -sw/2, -sh/2, sw, sh);
  octx.setTransform(1,0,0,1,0,0);
}

/* ===== 放射（四角断ち切り） ===== */
function clipWedgeAnnulus(outerR, innerR, halfAng){
  ctx.beginPath();
  ctx.arc(0,0,outerR,-halfAng,halfAng,false);
  ctx.arc(0,0,innerR, halfAng,-halfAng,true);
  ctx.closePath(); ctx.clip();
}
function drawRadial(baseRot){
  ctx.save();
  ctx.translate(CX,CY);
  ctx.rotate(baseRot);
  const ang=2*Math.PI/sectors, half=ang/2;
  for(let i=0;i<sectors;i++){
    ctx.save();
    ctx.rotate(i*ang);
    for(let r=0;r<rings;r++){
      const inner=R2*(r/rings), outer=R2*((r+1)/rings);
      ctx.save();
      clipWedgeAnnulus(outer, inner, half);
      if(i%2) ctx.scale(-1,1);
      const K = 1 + r*0.08;
      ctx.drawImage(off, -off.width/2*K, -off.height/2*K, off.width*K, off.height*K);
      ctx.restore();
    }
    ctx.restore();
  }
  ctx.restore();
}

/* ===== クリック/シェイクで “超スロー回転” ===== */
let spinStart=0, spinFrom=0, spinTo=0;
let SPIN_MS=6000;     // 6秒
let SPIN_TURNS=0.125; // 45°
const easeOutCubic = t => 1 - Math.pow(1 - t, 3);
const lerp=(a,b,t)=>a+(b-a)*t;

// 端末の reduced motion ならさらにゆっくり
if (matchMedia('(prefers-reduced-motion: reduce)').matches) {
  SPIN_MS = 8000;
  SPIN_TURNS = 0.1; // 36°
}

function currentSpin(){
  if(!spinStart) return spinTo||0;
  const p=Math.min(1,(performance.now()-spinStart)/SPIN_MS);
  return lerp(spinFrom, spinTo, easeOutCubic(p));
}
function triggerSpin(){
  const nowAngle=currentSpin();
  spinFrom=nowAngle;
  spinTo  =nowAngle + SPIN_TURNS*2*Math.PI;
  spinStart=performance.now();
}

cv.addEventListener('click', ()=>{
  triggerSpin();
  // チャイムはごく小さく（びっくり防止）
  try{const c=document.getElementById('chime'); c.volume=0.15; c.currentTime=0; c.play();}catch{}
});

/* ===== シェイク（任意で有効化） ===== */
let motionEnabled=false,lastShake=0;
function attachShake(){
  if(motionEnabled) return;
  const DME=window.DeviceMotionEvent;
  if(DME && typeof DME.requestPermission==='function'){
    DME.requestPermission().then(state=>{
      if(state==='granted'){window.addEventListener('devicemotion',onMotion,{passive:true}); motionEnabled=true;}
    });
  }else if('ondevicemotion' in window){
    window.addEventListener('devicemotion',onMotion,{passive:true}); motionEnabled=true;
  }
}
function onMotion(e){
  if(!shakeToggle.checked) return; // デフォは無効
  const a=e.accelerationIncludingGravity||e.acceleration; if(!a) return;
  const mag=Math.hypot(a.x||0,a.y||0,a.z||0);
  // 感度は低め＋長いクールダウン
  if(mag>20 && performance.now()-lastShake>3500){
    lastShake=performance.now(); triggerSpin();
  }
}
shakeToggle.addEventListener('change',()=>{
  if(shakeToggle.checked) attachShake();
});

/* ===== 色のロングフェード（とてもやさしく） ===== */
let tintStart=0, tintFrom=210, tintTo=210;
const TINT_MS = 6000; // 6秒
cv.addEventListener('click', ()=>{
  tintFrom=tintTo;
  const choices=[210,250,300,30,90,150];
  tintTo=choices[(Math.random()*choices.length)|0];
  tintStart=performance.now();
});

/* ===== ループ ===== */
function hsl2rgb(h,s,l){
  h=(h%360+360)%360; s=Math.max(0,Math.min(1,s)); l=Math.max(0,Math.min(1,l));
  const c=(1-Math.abs(2*l-1))*s, x=c*(1-Math.abs(((h/60)%2)-1)), m=l-c/2;
  let rr=0,gg=0,bb=0;
  if(h<60){rr=c;gg=x;} else if(h<120){rr=x;gg=c;}
  else if(h<180){gg=c;bb=x;} else if(h<240){gg=x;bb=c;}
  else if(h<300){rr=x;bb=c;} else {rr=c;bb=x;}
  return[(rr+m)*255,(gg+m)*255,(bb+m)*255];
}

let t0=performance.now();
(function loop(){
  const now=performance.now(), t=(now-t0)/1000;

  drawOff(t);

  ctx.clearRect(0,0,W,H);
  drawRadial(currentSpin());

  // 外枠（四角）
  ctx.save(); ctx.lineWidth=6; ctx.strokeStyle='rgba(255,255,255,0.12)';
  ctx.strokeRect(0,0,W,H); ctx.restore();

  // やわらかい色のヴェール
  const p=Math.min(1,(performance.now()-tintStart)/TINT_MS);
  const hue=tintFrom+(((tintTo-tintFrom+540)%360)-180)*p;
  const sat=0.38;                 // 彩度ひかえめ
  const lig=0.54 + 0.02*Math.sin(t*0.2); // ほんの少し明滅
  const [r,g,b]=hsl2rgb(hue,sat,lig);
  ctx.save();
  ctx.globalCompositeOperation='soft-light';
  ctx.globalAlpha=0.35;           // うすめのヴェール
  ctx.fillStyle=`rgb(${r|0},${g|0},${b|0})`;
  ctx.fillRect(0,0,W,H);
  ctx.restore();

  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
