<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Square Kaleidoscope â€” v12</title>

<link rel="manifest" href="./manifest.json?v=12">
<meta name="theme-color" content="#000000">
<link rel="icon" href="./icon-192.png">
<link rel="apple-touch-icon" href="./icon-192.png">

<style>
  html,body{margin:0;height:100%;background:#000;overflow:hidden}
  #c{width:100vw;height:100vh;display:block;touch-action:manipulation}
  #ui{
    position:fixed;bottom:10px;left:50%;transform:translateX(-50%);
    display:flex;gap:10px;align-items:center;color:#fff;font-family:sans-serif;
    font-size:14px;flex-wrap:wrap;justify-content:center;z-index:3
  }
  input[type=file]{appearance:auto;background:#111;color:#fff;border:1px solid #444;border-radius:8px;padding:8px 12px}
  button{background:#111;border:1px solid #444;border-radius:8px;padding:8px 14px;cursor:pointer;color:#fff}
  #status{position:fixed;top:10px;left:50%;transform:translateX(-50%);color:#9cf;font-family:monospace;font-size:12px;opacity:.95;z-index:3;text-align:center;white-space:pre-wrap;max-width:96vw}
  #install{position:fixed;top:10px;right:10px}
  #dropHint{position:fixed;inset:auto auto 64px 50%;transform:translateX(-50%);color:#bbb;font:12px/1.4 sans-serif;z-index:3;opacity:.9}
  label{display:flex;gap:6px;align-items:center}
  #plist{position:fixed;right:10px;bottom:80px;max-height:45vh;overflow:auto;background:#111a;color:#fff;border:1px solid #333;border-radius:10px;padding:8px 10px;font:12px/1.5 sans-serif;min-width:220px}
  #plist b{display:block;margin:.2em 0 .4em;color:#9cf}
  #plist li{list-style:none;padding:2px 0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:pointer}
  #plist li.playing{color:#0f0}
</style>
</head>
<body>
<canvas id="c"></canvas>
<div id="status">bootingâ€¦ (v12)</div>

<div id="ui">
  <input type="file" id="img" accept="image/*" title="ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ">
  <button id="reset">ç”»åƒã‚¯ãƒªã‚¢</button>

  <button id="enable">ğŸ”Š ã‚»ãƒ³ã‚µãƒ¼ã¨éŸ³ã‚’æœ‰åŠ¹åŒ–</button>

  <!-- âœ… ãƒ•ã‚©ãƒ«ãƒ€é¸æŠ + è¤‡æ•° -->
  <input type="file" id="music" accept="audio/*" webkitdirectory multiple title="éŸ³æ¥½ãƒ•ã‚©ãƒ«ãƒ€ï¼è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«">
  <button id="prev">â®</button>
  <button id="play">â–¶ï¸/â¸</button>
  <button id="next">â­</button>

  <label>ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ <input id="seg" type="range" min="8" max="96" step="2" value="32"></label>

  <button id="install" hidden>+ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</button>
</div>
<ul id="plist" hidden>
  <b>Playlist</b>
</ul>
<div id="dropHint">ğŸ–¼ ç”»åƒã¯ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã§ã‚‚èª­ã¿è¾¼ã‚ã¾ã™</div>

<audio id="chime" src="./Chime.m4a?v=12" preload="auto" playsinline></audio>
<audio id="player" preload="none" playsinline></audio>

<script>
/* ===== constants ===== */
const APP_VERSION = "v12";

/* ===== Service Workerï¼ˆå³æ™‚æ›´æ–°ï¼†è‡ªå‹•ãƒªãƒ­ãƒ¼ãƒ‰ï¼‰ ===== */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js?v=12').then(reg => {
    if (reg.waiting) reg.waiting.postMessage({type:'SKIP_WAITING'});
    reg.addEventListener('updatefound', () => {
      const sw = reg.installing;
      if (!sw) return;
      sw.addEventListener('statechange', () => {
        if (sw.state === 'installed' && reg.waiting) {
          reg.waiting.postMessage({type:'SKIP_WAITING'});
        }
      });
    });
  });
  navigator.serviceWorker.addEventListener('message', (event) => {
    if (event.data?.type === 'SW_ACTIVATED') location.reload();
  });
}

/* ===== PWA Install ===== */
let deferredPrompt;
const installBtn=document.getElementById('install');
window.addEventListener('beforeinstallprompt', e=>{e.preventDefault();deferredPrompt=e;installBtn.hidden=false;});
installBtn.onclick=async()=>{installBtn.hidden=true;if(deferredPrompt){deferredPrompt.prompt();await deferredPrompt.userChoice;deferredPrompt=null;}};

/* ===== basic ===== */
const canvas=document.getElementById('c'),ctx2d=canvas.getContext('2d'),statusEl=document.getElementById('status');
const dpr=Math.min(devicePixelRatio||1,2);
function log(t){statusEl.textContent=t}
function fit(){canvas.width=Math.floor(innerWidth*dpr);canvas.height=Math.floor(innerHeight*dpr);if(gl){gl.viewport(0,0,canvas.width,canvas.height);gl.uniform2f(prog.uRes,canvas.width,canvas.height);}}
addEventListener('resize',fit);fit();
function checker(){const w=canvas.width,h=canvas.height,s=32;for(let y=0;y<h;y+=s)for(let x=0;x<w;x+=s){ctx2d.fillStyle=((x+y)/s)%2?'#222':'#444';ctx2d.fillRect(x,y,s,s);}}
checker();log(`bootingâ€¦ (${APP_VERSION})`);

/* ===== WebGLï¼ˆæ”¾å°„ï¼‹æ­£æ–¹å½¢æ–­ã¡åˆ‡ã‚Šï¼‹ç‰‡ã‚»ã‚°ãƒ¡ãƒ³ãƒˆå†…ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰ ===== */
let gl,prog,tex=null,img2D=null;
function initGL(){
  gl=canvas.getContext('webgl',{alpha:false,antialias:true})||canvas.getContext('experimental-webgl');
  if(!gl) throw new Error('WebGLä¸å¯ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶è¨­å®š/ç’°å¢ƒï¼‰');

  const vs=`attribute vec2 aPos;varying vec2 vUv;void main(){vUv=(aPos+1.0)*0.5;gl_Position=vec4(aPos,0,1);}`;
  const fs=`
  precision mediump float;varying vec2 vUv;
  uniform float uTime,uSectors,uHasTex;uniform sampler2D uTex;uniform vec2 uRes;
  vec2 mirror(vec2 x){return abs(fract(x)-0.5)*2.0;}mat2 rot(float a){float c=cos(a),s=sin(a);return mat2(c,-s,s,c);}
  void main(){
    vec2 c=uRes*0.5;float side=min(uRes.x,uRes.y);vec2 p=(gl_FragCoord.xy-c)/side;
    if(max(abs(p.x),abs(p.y))>0.5){gl_FragColor=vec4(0,0,0,1);return;}
    float sector=6.28318530718/uSectors;float ang=atan(p.y,p.x);float k=floor(ang/sector);
    float a=mod(ang,sector);if(mod(k,2.0)>0.5)a=sector-a;
    float r=length(p);vec2 dir=vec2(cos(a),sin(a));
    float ph=k*2.618;float spin=0.12*sin(uTime*0.6+ph);vec2 d=rot(spin)*(dir*r);
    float br=1.0+0.18*sin(uTime*0.8+0.7*ph);vec2 t=d*br+0.5;
    vec2 slide=0.06*vec2(cos(uTime*0.5+ph),sin(uTime*0.7+1.3*ph));t+=slide;
    vec3 col=(uHasTex>0.5)?texture2D(uTex,mirror(t)).rgb:vec3(0.3+0.2*sin(10.0*t.x),0.3+0.2*sin(10.0*t.y),0.4);
    gl_FragColor=vec4(col,1.0);
  }`;
  const sh=(tp,src)=>{const s=gl.createShader(tp);gl.shaderSource(s,src);gl.compileShader(s);if(!gl.getShaderParameter(s,gl.COMPILE_STATUS))throw new Error(gl.getShaderInfoLog(s));return s;}
  const vsO=sh(gl.VERTEX_SHADER,vs),fsO=sh(gl.FRAGMENT_SHADER,fs);
  prog=gl.createProgram();gl.attachShader(prog,vsO);gl.attachShader(prog,fsO);gl.linkProgram(prog);
  if(!gl.getProgramParameter(prog,gl.LINK_STATUS))throw new Error(gl.getProgramInfoLog(prog));
  gl.useProgram(prog);
  const quad=new Float32Array([-1,-1,1,-1,-1,1,1,1]);const vbo=gl.createBuffer();
  gl.bindBuffer(gl.ARRAY_BUFFER,vbo);gl.bufferData(gl.ARRAY_BUFFER,quad,gl.STATIC_DRAW);
  const loc=gl.getAttribLocation(prog,'aPos');gl.enableVertexAttribArray(loc);gl.vertexAttribPointer(loc,2,gl.FLOAT,false,0,0);

  prog.uTime=gl.getUniformLocation(prog,'uTime');prog.uSectors=gl.getUniformLocation(prog,'uSectors');
  prog.uTex=gl.getUniformLocation(prog,'uTex');prog.uHasTex=gl.getUniformLocation(prog,'uHasTex');prog.uRes=gl.getUniformLocation(prog,'uRes');

  gl.uniform1f(prog.uSectors,parseFloat(document.getElementById('seg').value));
  gl.uniform1i(prog.uTex,0);gl.uniform1f(prog.uHasTex,0.0);
  gl.viewport(0,0,canvas.width,canvas.height);gl.uniform2f(prog.uRes,canvas.width,canvas.height);
  log('WebGL OK (v12)');
}
let startT=performance.now();
function loop(){const t=(performance.now()-startT)/1000;if(gl){gl.clearColor(0,0,0,1);gl.clear(gl.COLOR_BUFFER_BIT);gl.uniform1f(prog.uTime,t);gl.drawArrays(gl.TRIANGLE_STRIP,0,4);}else checker();requestAnimationFrame(loop);}requestAnimationFrame(loop);
try{initGL();}catch(e){log('WebGLå¤±æ•—: '+e.message);}

/* ===== ãƒ†ã‚¯ã‚¹ãƒãƒ£ä½œæˆ ===== */
function makeTex(img){
  if(!gl){img2D=img;return;}
  tex=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,tex);
  gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,true);
  gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,img);
  gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);
  gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);
  gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);
  gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);
  gl.uniform1f(prog.uHasTex,1.0);log('ç”»åƒãƒ­ãƒ¼ãƒ‰OK');
}

/* ===== ç”»åƒå…¥å‡ºåŠ› ===== */
document.getElementById('img').onchange=e=>{
  const f=e.target.files[0];if(!f)return;
  const u=URL.createObjectURL(f);const i=new Image();
  i.onload=()=>{makeTex(i);URL.revokeObjectURL(u);}
  i.onerror=()=>log('ç”»åƒèª­ã¿è¾¼ã¿å¤±æ•—');i.src=u;
};
document.getElementById('reset').onclick=()=>{img2D=null;if(gl)gl.uniform1f(prog.uHasTex,0.0);log('ç”»åƒã‚¯ãƒªã‚¢');};
addEventListener('dragover',e=>e.preventDefault());
addEventListener('drop',e=>{e.preventDefault();const f=e.dataTransfer.files?.[0];if(!f||!f.type.startsWith('image/'))return;
  const u=URL.createObjectURL(f);const i=new Image();i.onload=()=>{makeTex(i);URL.revokeObjectURL(u);} ;i.src=u;});

/* ===== ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªï¼ˆãƒãƒ£ã‚¤ãƒ ï¼é¸æŠéŸ³æº/æœªé¸æŠã¯å†…è”µï¼‰ ï¼‹ ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ ===== */
const ch=document.getElementById('chime'),pl=document.getElementById('player');let enabled=false;
const musicInput=document.getElementById('music');const plist=document.getElementById('plist');
let tracks=[], idx=-1;

document.getElementById('enable').onclick=async()=>{
  try{
    if(typeof DeviceMotionEvent!=='undefined'&&DeviceMotionEvent.requestPermission) await DeviceMotionEvent.requestPermission();
    await ch.play(); ch.pause(); ch.currentTime=0; enabled=true; log('éŸ³OKï¼ˆã‚¯ãƒªãƒƒã‚¯/ã‚·ã‚§ã‚¤ã‚¯å¯ï¼‰');
  }catch(e){ log('éŸ³å¤±æ•—: '+e.message); }
};

function tryPlay(el){ el.play().catch(e=>log('å†ç”Ÿå¤±æ•—: '+e.message)); }
function playChime(){ if(!enabled){log('å…ˆã«ã€Œã‚»ãƒ³ã‚µãƒ¼ã¨éŸ³ã‚’æœ‰åŠ¹åŒ–ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„'); return;} ch.currentTime=0; tryPlay(ch); }
canvas.addEventListener('pointerdown', playChime);
addEventListener('devicemotion',e=>{ const a=e.accelerationIncludingGravity||{x:0,y:0,z:0}; if(Math.hypot(a.x,a.y,a.z)>25) playChime(); },{passive:true});

musicInput.onchange=e=>{
  tracks=[...e.target.files].filter(f=>f.type.startsWith('audio/'));
  if(!tracks.length){ log('éŸ³æºãªã—'); plist.hidden=true; return; }
  // UIæ›´æ–°
  plist.hidden=false; plist.innerHTML='<b>Playlist</b>';
  tracks.forEach((f,i)=>{ const li=document.createElement('li'); li.textContent=f.webkitRelativePath||f.name; li.onclick=()=>start(i); plist.appendChild(li); });
  start(0);
};

function start(i){
  idx=i; const f=tracks[i]; const u=URL.createObjectURL(f);
  pl.src=u; ch.src=u; // ãƒãƒ£ã‚¤ãƒ ã‚‚åŒéŸ³æºã«
  pl.onloadedmetadata=()=>log('éŸ³æº: '+(f.name||'audio'));
  highlight();
  pl.onended=()=>next();
  tryPlay(pl);
}
function highlight(){
  [...plist.querySelectorAll('li')].forEach((li,i)=>li.classList.toggle('playing', i===idx));
}
function next(){ if(!tracks.length) return; start((idx+1)%tracks.length); }
function prev(){ if(!tracks.length) return; start((idx-1+tracks.length)%tracks.length); }

document.getElementById('play').onclick=()=>{ if(!pl.src) return log('éŸ³æºã‚’é¸æŠ'); if(pl.paused) pl.play(); else pl.pause(); };
document.getElementById('next').onclick=next;
document.getElementById('prev').onclick=prev;

/* ===== ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ ===== */
document.getElementById('seg').oninput=e=>{ if(gl) gl.uniform1f(prog.uSectors,parseFloat(e.target.value)); };
</script>
</body>
</html>
