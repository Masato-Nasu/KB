<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
  <title>KaleidoBaby Player â€” Folder Ready</title>
  <link rel="manifest" href="./manifest.json">
  <link rel="icon" href="./icon-192.png" type="image/png">
  <meta name="theme-color" content="#000000">
  <style>
    html, body { height: 100%; }
    body {
      margin: 0; background: #000; color: #fff;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      display: flex; flex-direction: column; align-items: center; padding: 16px;
    }
    canvas { width: 100%; max-width: 520px; aspect-ratio: 1/1;
             border-radius: 10px; background: #000; opacity: 0;
             transition: opacity .8s ease; pointer-events: none; }
    canvas.active { opacity: 1; pointer-events: auto; }
    #controls { display: flex; flex-direction: column; gap: 8px; width: 100%; max-width: 520px; margin-top: 16px; }
    #lcd, button, label {
      height: 48px; background: #111; border: 1px solid #444; border-radius: 10px;
      color: #fff; font-size: 16px; display: flex; align-items: center; justify-content: center;
      font-family: ui-monospace, monospace; cursor: pointer; white-space: nowrap;
    }
    #lcd span { animation: scroll 12s linear infinite; display: inline-block; }
    @keyframes scroll { from {transform:translateX(100%);} to {transform:translateX(-100%);} }
    input[type=file], audio { display: none; }
  </style>
</head>
<body>
  <canvas id="canvas"></canvas>
  <div id="controls">
    <div id="lcd"><span>NO FILES LOADED</span></div>
    <label id="folderButton">SELECT MUSIC FOLDER / FILES</label>
    <button id="playButton">PLAY</button>
    <button id="pauseButton">PAUSE</button>
    <button id="skipButton">NEXT</button>
    <button id="backButton">PREVIOUS</button>
    <input type="file" id="audioInput" accept="audio/*" multiple webkitdirectory>
  </div>
  <audio id="player" preload="metadata" playsinline></audio>

  <script src="https://cdn.jsdelivr.net/npm/meyda/dist/web/meyda.min.js"></script>
  <script>
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const size = 400;
  canvas.width = canvas.height = size;
  const imageData = ctx.createImageData(size, size);
  let U=new Float32Array(size*size).fill(1), V=new Float32Array(size*size).fill(0);
  for(let y=size/2-10;y<size/2+10;y++)for(let x=size/2-10;x<size/2+10;x++)V[y*size+x]=1;
  const du=0.16,dv=0.08; let flashFeed=0,flashKill=0;
  function lap(f,x,y){return f[((y-1+size)%size)*size+x]+f[((y+1)%size)*size+x]+f[y*size+((x-1+size)%size)]+f[y*size+((x+1)%size)]-4*f[y*size+x];}
  function step(){const U2=new Float32Array(U.length),V2=new Float32Array(V.length);
    const f=0.02+flashFeed,k=0.05+flashKill;flashFeed*=0.9;flashKill*=0.9;
    for(let i=0;i<U.length;i++){const y=Math.floor(i/size),x=i%size,u=U[i],v=V[i];
      const Lu=lap(U,x,y)*1.2,Lv=lap(V,x,y)*1.2;
      U2[i]=u+(du*Lu-u*v*v+f*(1-u));V2[i]=v+(dv*Lv+u*v*v-(f+k)*v);}
    U=U2;V=V2;}
  function draw(){const d=imageData.data;
    for(let i=0;i<U.length;i++){const c=Math.min(255,Math.max(0,(U[i]-V[i])*255));
      const p=i*4;d[p]=d[p+1]=d[p+2]=c;d[p+3]=255;}
    ctx.putImageData(imageData,0,0);}
  (function loop(){for(let i=0;i<2;i++)step();draw();requestAnimationFrame(loop);})();
  canvas.addEventListener('click',()=>{flashFeed=0.02;flashKill=-0.01;});

  const player=document.getElementById('player');
  const lcdSpan=document.querySelector('#lcd span');
  const lcd=t=>(lcdSpan.textContent=t);

  let playlist=[],urls=[],current=0,audioCtx,mediaSrc;
  function ensureGraph(){if(audioCtx)return;
    audioCtx=new(window.AudioContext||window.webkitAudioContext)();
    mediaSrc=audioCtx.createMediaElementSource(player);
    mediaSrc.connect(audioCtx.destination);
  }

  function sortNumeric(files){
    return files.sort((a,b)=>{
      const ra=a.name.match(/\d+/),rb=b.name.match(/\d+/);
      if(ra&&rb)return ra[0]-rb[0];
      return a.name.localeCompare(b.name,'ja',{numeric:true});
    });
  }
  function revokeAll(){urls.forEach(u=>URL.revokeObjectURL(u));urls=[];}
  async function replacePlaylist(files,label=''){
    revokeAll(); playlist=sortNumeric(files.filter(f=>f.type.startsWith('audio/')||/\.(mp3|wav|m4a|ogg)$/i.test(f.name)));
    urls=playlist.map(f=>URL.createObjectURL(f));
    current=0;
    lcd(playlist.length?`LOADED ${playlist.length} FILES ${label}`:'NO FILES');
    if(playlist.length){canvas.classList.add('active'); await play(0);}
  }

  async function play(index=current){
    if(!playlist.length)return;
    current=Math.max(0,Math.min(index,playlist.length-1));
    player.src=urls[current];
    ensureGraph();
    try{await audioCtx.resume();await player.play();}catch(e){console.warn(e);}
    lcd(`PLAYING ${playlist[current].name}`);
  }

  function pauseManual(){player.pause();lcd('PAUSED');}
  player.addEventListener('ended',()=>play((current+1)%playlist.length));
  document.getElementById('playButton').onclick=()=>play(current);
  document.getElementById('pauseButton').onclick=pauseManual;
  document.getElementById('skipButton').onclick=()=>play((current+1)%playlist.length);
  document.getElementById('backButton').onclick=()=>play((current-1+playlist.length)%playlist.length);

  const audioInput=document.getElementById('audioInput');
  document.getElementById('folderButton').onclick=async()=>{
    try{
      if('showDirectoryPicker'in window){
        const h=await window.showDirectoryPicker({mode:'read'});
        const files=[];
        for await(const [n,e]of h.entries()){
          if(e.kind==='file')files.push(await e.getFile());
        }
        await replacePlaylist(files,h.name);
      }else audioInput.click();
    }catch{audioInput.click();}
  };
  audioInput.onchange=e=>replacePlaylist([...e.target.files||[]]);

  if('serviceWorker'in navigator){addEventListener('load',()=>navigator.serviceWorker.register('./sw.js').catch(()=>{}));}
  </script>
</body>
</html>
