<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Baby Shapes ‚Äî „Åï„Çè„Å£„Å¶ÂÖâ„Çã „Äá‚ñ≥‚ñ°‚òÜ‚ô°</title>
<link rel="manifest" href="./manifest.json?v=1">
<meta name="theme-color" content="#FFF8E7">
<style>
  :root{ --bg:#FFF8E7; --panel:#ffffffcc; --text:#1f2a44; --muted:#5b6275; }
  html,body{ height:100%; margin:0; background:var(--bg); color:var(--text);
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif; }
  .wrap{display:flex;flex-direction:column;align-items:center;gap:12px;min-height:100%}
  .stage{position:relative;display:grid;place-items:center;width:100%;max-width:1100px;aspect-ratio:1;
    background:var(--bg);border-radius:24px;overflow:hidden;box-shadow:0 12px 36px rgba(0,0,0,.15)}
  canvas{width:100%;height:100%;display:block;touch-action:none}
  .controls{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;align-items:center;
    padding:12px;background:var(--panel);backdrop-filter:saturate(1.2) blur(6px);
    border-radius:16px;margin:8px;max-width:1100px}
  .btn{appearance:none;border:0;border-radius:14px;background:#2f6feb;color:#fff;
    padding:12px 16px;font-size:16px;display:inline-flex;align-items:center;gap:8px;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .range{display:inline-flex;align-items:center;gap:10px;background:#ffffff; color:#1f2a44;
    border-radius:14px;padding:10px 12px; box-shadow:0 2px 8px rgba(0,0,0,.06)}
  input[type="range"]{width:160px}
  .muted{color:var(--muted);font-size:12px;margin-top:-6px;text-align:center}
</style>
</head>
<body>
<div class="wrap">
  <div class="stage" id="stage"><canvas id="cv"></canvas></div>
  <div class="controls">
    <label class="btn">üéµ „Åä„Çì„Åå„Åè„Éï„Ç©„É´„ÉÄ<input id="audDir" type="file" webkitdirectory directory multiple accept="audio/*" hidden></label>
    <button id="prev" class="btn">‚Üê „Åæ„Åà</button>
    <button id="play" class="btn">‚ñ∂ / ‚ùö‚ùö</button>
    <button id="next" class="btn">„Å§„Åé ‚Üí</button>
    <div class="range">„Åã„Åö <input id="count" type="range" min="8" max="40" step="1" value="18"></div>
    <div class="range">„Åä„Åä„Åç„Åï <input id="size" type="range" min="32" max="140" step="2" value="80"></div>
  </div>
  <div class="muted">Baby Shapes v1: „Äá‚ñ≥‚ñ°‚òÜ‚ô° „Åå„ÇÜ„Å£„Åè„Çä„ÅÜ„Åî„Åè„ÄÇ„Åï„Çè„Çã„Å® „Å¥„Åã„Å£Ôºã„ÅΩ„Çà„Çì‚ô™„ÄÇ„Åä„Çì„Åå„Åè„Å´„ÇÇ„ÅØ„Çì„ÅÆ„ÅÜÔºèPWA„ÄÇ</div>
</div>

<script>
(() => {
  const cv = document.getElementById('cv');
  const ctx = cv.getContext('2d', { alpha:false });
  const stage = document.getElementById('stage');
  const countUI = document.getElementById('count');
  const sizeUI  = document.getElementById('size');

  // ===== palette (saturation up) =====
  const COLORS = {
    circle:"#8CB3FF",  // ‚óã Á©∫Ëâ≤
    triangle:"#B9F5C8",// ‚ñ≥ „Ç∞„É™„Éº„É≥
    square:"#6BE0D1",  // ‚ñ° „Éü„É≥„Éà
    star:"#B0AEFF",    // ‚òÜ ÈùíÁ¥´
    heart:"#FFA8C4"    // ‚ô° „Éî„É≥„ÇØ
  };
  const BG = "#FFF8E7";

  // ===== Audio (folder) =====
  let audList=[], audIdx=0, audio=new Audio(); audio.preload="auto";
  let actx, analyser, data, playing=false;
  function ensureAudio(){
    if(actx) return;
    actx = new (window.AudioContext||window.webkitAudioContext)();
    const src = actx.createMediaElementSource(audio);
    analyser = actx.createAnalyser(); analyser.fftSize=256;
    data = new Uint8Array(analyser.frequencyBinCount);
    src.connect(analyser); analyser.connect(actx.destination);
  }
  function naturalSort(a,b){ return a.name.localeCompare(b.name,'ja',{numeric:true}); }
  document.getElementById('audDir').addEventListener('change', e=>{
    ensureAudio();
    audList = [...e.target.files].filter(f=>f.type.startsWith('audio/')).sort(naturalSort);
    audIdx=0; if(audList.length) playIndex(audIdx);
  });
  async function playIndex(i){
    if(!audList.length) return;
    audio.src = URL.createObjectURL(audList[i]);
    try{ if(actx.state!=="running") await actx.resume(); await audio.play(); playing=true; }catch(e){}
  }
  document.getElementById('next').addEventListener('click',()=>{ if(!audList.length)return; audIdx=(audIdx+1)%audList.length; playIndex(audIdx); });
  document.getElementById('prev').addEventListener('click',()=>{ if(!audList.length)return; audIdx=(audIdx-1+audList.length)%audList.length; playIndex(audIdx); });
  document.getElementById('play').addEventListener('click', async ()=>{
    ensureAudio(); if(actx.state!=="running") await actx.resume();
    if(audio.paused){ await audio.play(); playing=true; } else { audio.pause(); playing=false; }
  });

  // ===== Canvas sizing =====
  const dprCap=1.2;
  function fit(){
    const s=Math.min(stage.clientWidth, stage.clientHeight);
    const dpr=Math.min(window.devicePixelRatio||1, dprCap);
    cv.width=cv.height=Math.max(320,Math.floor(s*dpr));
  }
  const ro=new ResizeObserver(()=>fit()); ro.observe(stage); fit();
  let lastDPR=window.devicePixelRatio; setInterval(()=>{ if(window.devicePixelRatio!==lastDPR){ lastDPR=window.devicePixelRatio; fit(); } }, 600);

  // ===== Shapes =====
  const TYPES = ["circle","triangle","square","star","heart"];
  function starPath(r, spikes=5){
    const p=new Path2D(); const step=Math.PI/spikes;
    p.moveTo(r,0);
    for(let i=0;i<spikes*2;i++){
      const rr = (i%2===0)? r : r*0.45;
      const a = i*step;
      p.lineTo(Math.cos(a)*rr, Math.sin(a)*rr);
    }
    p.closePath(); return p;
  }
  function heartPath(r){
    const p=new Path2D();
    // simple parametric heart
    p.moveTo(0,-r*0.3);
    p.bezierCurveTo(r*0.8,-r*1.1, r*1.6,r*0.4, 0,r*1.2);
    p.bezierCurveTo(-r*1.6,r*0.4, -r*0.8,-r*1.1, 0,-r*0.3);
    return p;
  }

  const starCache = new Map(); const heartCache = new Map();
  function getStar(r){ const k=r|0; if(!starCache.has(k)) starCache.set(k, starPath(k)); return starCache.get(k); }
  function getHeart(r){ const k=r|0; if(!heartCache.has(k)) heartCache.set(k, heartPath(k)); return heartCache.get(k); }

  const shapes=[];
  function resetShapes(){
    shapes.length=0;
    const n=parseInt(countUI.value,10);
    for(let i=0;i<n;i++){
      const type=TYPES[i%TYPES.length];
      const base = parseFloat(sizeUI.value);
      const r = base*(0.7 + Math.random()*0.6);
      const x = Math.random()*cv.width;
      const y = Math.random()*cv.height;
      const rot = Math.random()*Math.PI*2;
      const vx = (Math.random()-0.5)*0.6;
      const vy = (Math.random()-0.5)*0.6;
      shapes.push({type,x,y,r,rot,vx,vy,pulse:0,color:COLORS[type]});
    }
  }
  countUI.addEventListener('input', resetShapes);
  sizeUI.addEventListener('input', ()=>{
    for(const s of shapes){ s.r = parseFloat(sizeUI.value)*(0.7 + Math.random()*0.6); }
  });
  resetShapes();

  // interaction
  const chime = new Audio("./Chime.mp3"); chime.volume = 0.45;
  function toLocal(e){
    const r=stage.getBoundingClientRect();
    return { x:(e.clientX-r.left)/r.width*cv.width, y:(e.clientY-r.top)/r.height*cv.height };
  }
  stage.addEventListener('pointerdown', (e)=>{
    const p=toLocal(e);
    // find nearest shape
    let target=null, d2Min=1e9;
    for(const s of shapes){
      const d2=(s.x-p.x)**2 + (s.y-p.y)**2;
      if(d2<d2Min){ d2Min=d2; target=s; }
    }
    if(target && d2Min < (target.r*1.2)**2){
      target.pulse = 1.0; // pop
      try{ chime.currentTime=0; chime.play(); }catch(_){}
      // gentle push
      const ang=Math.atan2(target.y-p.y, target.x-p.x);
      target.vx += Math.cos(ang)*1.0;
      target.vy += Math.sin(ang)*1.0;
    }
  });

  // motion (shake ‚Üí pulse)
  if (window.DeviceMotionEvent){
    let last=0;
    window.addEventListener('devicemotion', (e)=>{
      const a=e.accelerationIncludingGravity||{}; const x=a.x||0,y=a.y||0,z=a.z||0;
      const s=Math.sqrt(x*x+y*y+z*z);
      if(s>18 && Date.now()-last>800){
        for(const sh of shapes){ sh.pulse = Math.min(1, sh.pulse+0.8); }
        try{ chime.currentTime=0; chime.play(); }catch(_){}
        last=Date.now();
      }
    }, {passive:true});
  }

  // ===== draw =====
  let t=0;
  function draw(){
    const w=cv.width,h=cv.height;
    ctx.fillStyle=BG; ctx.fillRect(0,0,w,h);

    // audio energy ‚Üí breathing
    let low=0, mid=0;
    if(analyser && playing){
      analyser.getByteFrequencyData(data);
      const n=data.length;
      for(let i=0;i<n;i++){
        const v=data[i]/255;
        if(i<n*0.5) low+=v; else mid+=v;
      }
      low/=n*0.5; mid/=n*0.5;
    }

    for(const s of shapes){
      // move
      s.x+=s.vx; s.y+=s.vy; s.rot+=0.01*(0.5+mid);
      // bounce at edges
      if(s.x<s.r){ s.x=s.r; s.vx=Math.abs(s.vx); }
      if(s.x>w-s.r){ s.x=w-s.r; s.vx=-Math.abs(s.vx); }
      if(s.y<s.r){ s.y=s.r; s.vy=Math.abs(s.vy); }
      if(s.y>h-s.r){ s.y=h-s.r; s.vy=-Math.abs(s.vy); }
      s.vx*=0.995; s.vy*=0.995;

      // breathing size
      const breath = 0.06*Math.sin(t*0.03 + s.x*0.002) + low*0.12 + s.pulse*0.25;
      const r = s.r * (1 + breath);
      s.pulse *= 0.92;

      ctx.save();
      ctx.translate(s.x, s.y);
      ctx.rotate(s.rot);
      ctx.shadowColor = s.color;
      ctx.shadowBlur = 20 + 60*(low + s.pulse);
      ctx.fillStyle = s.color;

      switch(s.type){
        case "circle":
          ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fill(); break;
        case "triangle":
          ctx.beginPath();
          const htri = r*1.1;
          ctx.moveTo(0,-htri);
          ctx.lineTo(htri*Math.sin(Math.PI/3), htri*Math.cos(Math.PI/3));
          ctx.lineTo(-htri*Math.sin(Math.PI/3), htri*Math.cos(Math.PI/3));
          ctx.closePath(); ctx.fill(); break;
        case "square":
          ctx.fillRect(-r,-r,r*2,r*2); break;
        case "star":
          ctx.fill(getStar(r)); break;
        case "heart":
          ctx.fill(getHeart(r)); break;
      }
      ctx.restore();
    }

    t += 1;
    requestAnimationFrame(draw);
  }
  requestAnimationFrame(draw);
})();
</script>
<script>
if("serviceWorker" in navigator){ navigator.serviceWorker.register("./sw.js?v=1"); }
</script>
</body>
</html>
