<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>KaleidoBaby Neo — Pastel Mirror Reactive Edition</title>
<link rel="manifest" href="./manifest.json">
<link rel="icon" href="./icon-192.png" type="image/png">
<meta name="theme-color" content="#000">
<style>
html,body{margin:0;height:100%;background:#000;color:#fff;font-family:system-ui;display:flex;flex-direction:column;align-items:center;justify-content:center;overflow:hidden}
canvas{width:100%;max-width:520px;aspect-ratio:1/1;border-radius:12px;background:#000;transition:opacity .8s ease;}
#controls{display:flex;flex-direction:column;align-items:center;gap:8px;margin-top:12px}
#lcd,button,label{height:44px;min-width:200px;background:#111;border:1px solid #444;border-radius:10px;color:#fff;display:flex;align-items:center;justify-content:center;font-family:ui-monospace;font-size:14px;cursor:pointer}
input[type=file],audio{display:none}
</style>
</head>
<body>
<canvas id="canvas"></canvas>
<div id="controls">
<div id="lcd"><span>NO FILES LOADED</span></div>
<label id="folderButton">SELECT MUSIC FOLDER / FILES</label>
<button id="playButton">PLAY</button>
<button id="pauseButton">PAUSE</button>
</div>
<input type="file" id="audioInput" accept="audio/*" multiple webkitdirectory>
<audio id="player" preload="metadata" playsinline></audio>
<script src="https://cdn.jsdelivr.net/npm/meyda/dist/web/meyda.min.js"></script>
<script>
const canvas=document.getElementById('canvas'),ctx=canvas.getContext('2d');
const size=256;canvas.width=canvas.height=size;
const off=document.createElement('canvas');off.width=off.height=size/2;const octx=off.getContext('2d');

let t=0,hueBase=0,pulse=0,rms=0;
function hslToRgb(h,s,l){let r,g,b;if(s==0){r=g=b=l;}else{const hue2rgb=(p,q,t)=>{if(t<0)t+=1;if(t>1)t-=1;if(t<1/6)return p+(q-p)*6*t;if(t<1/2)return q;if(t<2/3)return p+(q-p)*(2/3-t)*6;return p;};const q=l<0.5?l*(1+s):l+s-l*s;const p=2*l-q;r=hue2rgb(p,q,h+1/3);g=hue2rgb(p,q,h);b=hue2rgb(p,q,h-1/3);}return[r*255,g*255,b*255];}
function drawPattern(){
  const w=size/2;const img=octx.createImageData(w,w);const d=img.data;
  for(let y=0;y<w;y++){for(let x=0;x<w;x++){const nx=(x-w/2)/w*6,ny=(y-w/2)/w*6;
    const v=Math.sin(nx*3+t*1.2)+Math.cos(ny*3-t*1.3);
    const h=(hueBase+v*20)%360;
    const l=0.4+0.3*Math.sin(v*2+t)+pulse*0.5;
    const rgb=hslToRgb(h/360,0.4,l);
    const p=(y*w+x)*4;
    d[p]=rgb[0];d[p+1]=rgb[1];d[p+2]=rgb[2];d[p+3]=255;
  }}
  octx.putImageData(img,0,0);
  ctx.save();ctx.clearRect(0,0,size,size);
  for(let mx of [1,-1])for(let my of [1,-1]){
    ctx.save();ctx.scale(mx,my);
    ctx.drawImage(off,mx<0?-size/2:0,my<0?-size/2:0,size/2,size/2);
    ctx.restore();
  }
  ctx.restore();
  pulse*=0.9;
}
function loop(){
  t+=0.02+Math.min(rms*5,0.05);
  drawPattern();
  requestAnimationFrame(loop);
}
loop();
canvas.addEventListener('click',()=>{pulse=1;hueBase=(hueBase+30)%360;});

// === Audio ===
const player=document.getElementById('player');
let audioCtx,source,analyzer,meydaAnalyzer;
const lcdSpan=document.querySelector('#lcd span');const lcd=t=>lcdSpan.textContent=t;
let playlist=[],urls=[],current=0;
function ensureGraph(){
  if(audioCtx)return;
  audioCtx=new(window.AudioContext||window.webkitAudioContext)();
  source=audioCtx.createMediaElementSource(player);
  analyzer=audioCtx.createAnalyser();analyzer.fftSize=512;
  source.connect(analyzer);analyzer.connect(audioCtx.destination);
  meydaAnalyzer=Meyda.createMeydaAnalyzer({
    audioContext:audioCtx,source:analyzer,bufferSize:256,featureExtractors:['rms'],
    callback:features=>{rms=features.rms;}
  });
  try{meydaAnalyzer.start();}catch{}
}
function sortNumeric(files){return files.sort((a,b)=>{const ra=a.name.match(/\d+/),rb=b.name.match(/\d+/);if(ra&&rb)return ra[0]-rb[0];return a.name.localeCompare(b.name,'ja',{numeric:true});});}
function revokeAll(){urls.forEach(u=>URL.revokeObjectURL(u));urls=[];}
async function replacePlaylist(files,label=''){revokeAll();playlist=sortNumeric(files.filter(f=>f.type.startsWith('audio/')||/\.(mp3|wav|m4a|ogg)$/i.test(f.name)));urls=playlist.map(f=>URL.createObjectURL(f));current=0;lcd(playlist.length?`LOADED ${playlist.length} FILES ${label}`:'NO FILES');if(playlist.length){await play(0);}}
async function play(index=current){if(!playlist.length)return;current=Math.max(0,Math.min(index,playlist.length-1));player.src=urls[current];ensureGraph();try{await audioCtx.resume();await player.play();}catch(e){console.warn(e);}lcd(`PLAYING ${playlist[current].name}`);}
function handleNextTrack(){const next=(current+1)%playlist.length;setTimeout(()=>play(next),300);}
player.addEventListener('ended',handleNextTrack);
document.getElementById('playButton').onclick=()=>play(current);
document.getElementById('pauseButton').onclick=()=>{player.pause();lcd('PAUSED');};
document.getElementById('folderButton').onclick=async()=>{try{if('showDirectoryPicker'in window){const h=await window.showDirectoryPicker({mode:'read'});const files=[];for await(const [n,e]of h.entries()){if(e.kind==='file')files.push(await e.getFile());}await replacePlaylist(files,h.name);}else audioInput.click();}catch{audioInput.click();}};
audioInput.onchange=e=>replacePlaylist([...e.target.files||[]]);
if('serviceWorker'in navigator){addEventListener('load',()=>navigator.serviceWorker.register('./sw.js').catch(()=>{}));}
</script>
</body>
</html>