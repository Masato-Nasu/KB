<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
<title>KaleidoBaby â€” Mirror Reactive Edition</title>
<link rel="manifest" href="./manifest.json">
<link rel="icon" href="./icon-192.png" type="image/png">
<meta name="theme-color" content="#000">
<style>
html,body{margin:0;height:100%;background:#000;color:#fff;font-family:system-ui;display:flex;flex-direction:column;align-items:center;justify-content:center}
canvas{width:100%;max-width:520px;aspect-ratio:1/1;border-radius:12px;background:#000;transition:opacity .8s ease;}
#controls{display:flex;flex-direction:column;align-items:center;gap:8px;margin-top:12px}
#lcd,button,label{height:44px;min-width:200px;background:#111;border:1px solid #444;border-radius:10px;color:#fff;display:flex;align-items:center;justify-content:center;font-family:ui-monospace;font-size:14px;cursor:pointer}
input[type=file],audio{display:none}
</style>
</head>
<body>
<canvas id="canvas"></canvas>
<div id="controls">
<div id="lcd"><span>NO FILES LOADED</span></div>
<label id="folderButton">SELECT MUSIC FOLDER / FILES</label>
<button id="playButton">PLAY</button>
<button id="pauseButton">PAUSE</button>
</div>
<input type="file" id="audioInput" accept="audio/*" multiple webkitdirectory>
<audio id="player" preload="metadata" playsinline></audio>
<script src="https://cdn.jsdelivr.net/npm/meyda/dist/web/meyda.min.js"></script>
<script>
const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d');
const size=256;
canvas.width=canvas.height=size;
const off=document.createElement('canvas');
off.width=off.height=size/2;
const octx=off.getContext('2d');

let U=new Float32Array((size/2)*(size/2)).fill(1),V=new Float32Array(U.length).fill(0);
for(let y=size/4-8;y<size/4+8;y++)for(let x=size/4-8;x<size/4+8;x++)V[y*(size/2)+x]=1;
const du=0.16,dv=0.08;let flashFeed=0,flashKill=0,hueShift=0,pulse=0;

function lap(f,x,y,w){return f[((y-1+w)%w)*w+x]+f[((y+1)%w)*w+x]+f[y*w+((x-1+w)%w)]+f[y*w+((x+1)%w)]-4*f[y*w+x];}
function step(){const w=size/2;const U2=new Float32Array(U.length),V2=new Float32Array(V.length);
const f=0.02+flashFeed,k=0.05+flashKill;flashFeed*=0.9;flashKill*=0.9;
for(let i=0;i<U.length;i++){const y=Math.floor(i/w),x=i%w;const u=U[i],v=V[i];const Lu=lap(U,x,y,w)*1.2,Lv=lap(V,x,y,w)*1.2;
U2[i]=u+(du*Lu-u*v*v+f*(1-u));V2[i]=v+(dv*Lv+u*v*v-(f+k)*v);}U=U2;V=V2;}

function hslToRgb(h,s,l){let r,g,b;if(s==0){r=g=b=l;}else{const hue2rgb=(p,q,t)=>{if(t<0)t+=1;if(t>1)t-=1;if(t<1/6)return p+(q-p)*6*t;if(t<1/2)return q;if(t<2/3)return p+(q-p)*(2/3-t)*6;return p;};const q=l<0.5?l*(1+s):l+s-l*s;const p=2*l-q;r=hue2rgb(p,q,h+1/3);g=hue2rgb(p,q,h);b=hue2rgb(p,q,h-1/3);}return[r*255,g*255,b*255];}

function draw(){
const w=size/2;const img=octx.createImageData(w,w);const d=img.data;
for(let i=0;i<U.length;i++){const c=Math.min(1,Math.max(0,(U[i]-V[i])));
const x=i%w,y=Math.floor(i/w);const dx=x-w/2,dy=y-w/2;const dist=Math.sqrt(dx*dx+dy*dy);
const glow=Math.max(0,pulse-dist/50);const h=(hueShift+c*360)%360;const rgb=hslToRgb(h/360,0.9,0.4+glow*0.6);
const p=i*4;d[p]=rgb[0];d[p+1]=rgb[1];d[p+2]=rgb[2];d[p+3]=255;}
octx.putImageData(img,0,0);
ctx.save();
ctx.clearRect(0,0,size,size);
for(let mx of [1,-1])for(let my of [1,-1]){ctx.save();ctx.scale(mx,my);ctx.drawImage(off,mx<0? -size/2:0,my<0? -size/2:0,size/2,size/2);ctx.restore();}
ctx.restore();
pulse*=0.9;
}
(function loop(){for(let i=0;i<2;i++)step();draw();requestAnimationFrame(loop);})();
canvas.addEventListener('click',()=>{flashFeed=0.02;flashKill=-0.01;pulse=1;hueShift=(hueShift+60)%360;});

const player=document.getElementById('player');
const lcdSpan=document.querySelector('#lcd span');
const lcd=t=>(lcdSpan.textContent=t);
let playlist=[],urls=[],current=0,audioCtx,mediaSrc;
function ensureGraph(){if(audioCtx)return;audioCtx=new(window.AudioContext||window.webkitAudioContext)();mediaSrc=audioCtx.createMediaElementSource(player);mediaSrc.connect(audioCtx.destination);}

function sortNumeric(files){return files.sort((a,b)=>{const ra=a.name.match(/\d+/),rb=b.name.match(/\d+/);if(ra&&rb)return ra[0]-rb[0];return a.name.localeCompare(b.name,'ja',{numeric:true});});}
function revokeAll(){urls.forEach(u=>URL.revokeObjectURL(u));urls=[];}
async function replacePlaylist(files,label=''){revokeAll();playlist=sortNumeric(files.filter(f=>f.type.startsWith('audio/')||/\.(mp3|wav|m4a|ogg)$/i.test(f.name)));urls=playlist.map(f=>URL.createObjectURL(f));current=0;lcd(playlist.length?`LOADED ${playlist.length} FILES ${label}`:'NO FILES');if(playlist.length){await play(0);}}

async function play(index=current){if(!playlist.length)return;current=Math.max(0,Math.min(index,playlist.length-1));player.src=urls[current];ensureGraph();try{await audioCtx.resume();await player.play();}catch(e){console.warn(e);}lcd(`PLAYING ${playlist[current].name}`);}
function handleNextTrack(){const next=(current+1)%playlist.length;setTimeout(()=>play(next),300);}
player.addEventListener('ended',handleNextTrack);
document.getElementById('playButton').onclick=()=>play(current);
document.getElementById('pauseButton').onclick=()=>{player.pause();lcd('PAUSED');};
document.getElementById('folderButton').onclick=async()=>{try{if('showDirectoryPicker'in window){const h=await window.showDirectoryPicker({mode:'read'});const files=[];for await(const [n,e]of h.entries()){if(e.kind==='file')files.push(await e.getFile());}await replacePlaylist(files,h.name);}else audioInput.click();}catch{audioInput.click();}};
audioInput.onchange=e=>replacePlaylist([...e.target.files||[]]);
if('serviceWorker'in navigator){addEventListener('load',()=>navigator.serviceWorker.register('./sw.js').catch(()=>{}));}
</script>
</body>
</html>