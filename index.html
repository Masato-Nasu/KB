<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>ä¸‡è¯é¡ Finalï¼ˆå››è§’æ ï¼‹å¯¾è§’è¶…ãˆå††ç›¤ï¼‰</title>

<link rel="manifest" href="./manifest.json?v=14">
<meta name="theme-color" content="#111318">
<link rel="icon" href="./icon-192.png" type="image/png">
<link rel="apple-touch-icon" href="./icon-192.png">

<style>
  :root{--bg:#0b0d11;--fg:#d7e4ff;--muted:#86a2c9}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  #app{position:fixed;inset:0;display:grid;grid-template-rows:1fr auto;justify-items:center;align-items:center}
  canvas{background:#000;display:block;box-shadow:0 0 0 1px #111 inset}
  .bar{width:100%;display:flex;gap:.6rem;flex-wrap:wrap;align-items:center;justify-content:center;padding:.7rem;background:linear-gradient(180deg, rgba(14,18,24,.6), rgba(14,18,24,.95));backdrop-filter:blur(6px);border-top:1px solid #1e2733}
  .btn{background:#0f1a27;border:1px solid #263244;color:var(--fg);padding:.55rem .8rem;border-radius:.8rem;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .pill{font-size:.9rem;color:var(--muted)}
  .status{position:fixed;left:.6rem;top:.3rem;color:#9cc3ff;font-family:ui-monospace,Consolas,monospace;font-size:.85rem;opacity:.9;max-width:92vw;white-space:pre-wrap;pointer-events:none}
  input[type=file]{display:none}
  label.file{cursor:pointer}
  .group{display:inline-flex;align-items:center;gap:.35rem}
  .toggle{display:inline-flex;align-items:center;gap:.35rem}
</style>
</head>
<body>
<div id="app">
  <canvas id="cv" width="1024" height="1024"></canvas>

  <div class="bar" id="ui">
    <!-- ç”»åƒï¼šå˜ä½“/ãƒ•ã‚©ãƒ«ãƒ€ -->
    <input id="imgFile" type="file" accept="image/*">
    <label for="imgFile" class="btn file">ğŸ“· ç”»åƒ</label>
    <input id="dirPicker" type="file" webkitdirectory multiple accept="image/*">
    <label for="dirPicker" class="btn file">ğŸ“ ãƒ•ã‚©ãƒ«ãƒ€ï¼ˆç”»åƒï¼‰</label>
    <button id="prevBtn" class="btn">âŸµ å‰</button>
    <button id="nextBtn" class="btn">æ¬¡ âŸ¶</button>
    <button id="testImgBtn" class="btn">ğŸ§ª ãƒ†ã‚¹ãƒˆç”»åƒ</button>
    <button id="clearImg" class="btn">ç”»åƒã‚¯ãƒªã‚¢</button>
    <span class="pill">(D&Då¯ï¼â†â†’ã§åˆ‡æ›¿)</span>

    <!-- åˆ†å‰²ã¨æ”¾å°„ -->
    <div class="group">
      <label>åˆ†å‰² NÃ—N</label>
      <input id="gridN" type="range" min="1" max="32" value="12"><span id="gridNV">12</span>
    </div>
    <div class="group">
      <label>æ”¾å°„ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ</label>
      <input id="segs" type="range" min="6" max="72" value="24"><span id="segsV">24</span>
    </div>

    <!-- éŸ³æ¥½ï¼šå˜ä½“/ãƒ•ã‚©ãƒ«ãƒ€ -->
    <input id="musicFile" type="file" accept="audio/*">
    <label for="musicFile" class="btn file">ğŸµ éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«</label>
    <button id="musicPlay" class="btn">â–¶ å†ç”Ÿ/ä¸€æ™‚åœæ­¢</button>

    <input id="musicDir" type="file" webkitdirectory multiple accept="audio/*">
    <label for="musicDir" class="btn file">ğŸ“ ãƒ•ã‚©ãƒ«ãƒ€ï¼ˆéŸ³æ¥½ï¼‰</label>
    <button id="prevTrack" class="btn">âŸµ å‰ã®æ›²</button>
    <button id="nextTrack" class="btn">æ¬¡ã®æ›² âŸ¶</button>
    <span id="trackInfo" class="pill"></span>

    <!-- ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚¯ãƒªãƒƒã‚¯ã®æŒ™å‹• -->
    <label class="toggle"><input type="checkbox" id="chimeOnCanvas"> ğŸ””ã‚¯ãƒªãƒƒã‚¯ã§Chime</label>
  </div>
</div>

<pre class="status" id="status"></pre>

<script>
/* ===== åŸºæœ¬è¦ç´  ===== */
const cv=document.getElementById('cv'),ctx=cv.getContext('2d');
let baseImg=null,fileList=[],fileIdx=-1;
let patternCanvas=null,patternCtx=null;
let gridN=12,segments=24,angle=0;

/* ===== ã‚ªãƒ¼ãƒ‡ã‚£ã‚ª ===== */
let audioCtx=null;
const chimeAudio=new Audio('https://raw.githubusercontent.com/Masato-Nasu/KB/main/Chime.mp3');chimeAudio.preload='auto';
const music=new Audio();music.loop=false;
async function ensureAudioCtx(){if(!audioCtx){const AC=window.AudioContext||window.webkitAudioContext;audioCtx=new AC();}if(audioCtx.state==='suspended')await audioCtx.resume();}
function playBeep(freq=880,dur=0.18){if(!audioCtx)return;const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type='sine';o.frequency.value=freq;g.gain.value=0;o.connect(g).connect(audioCtx.destination);const t=audioCtx.currentTime;g.gain.linearRampToValueAtTime(0.22,t+0.01);g.gain.exponentialRampToValueAtTime(0.0001,t+dur);o.start(t);o.stop(t+dur+0.02);}

/* ===== ç”»åƒã® cover è¨ˆç®— ===== */
function computeCoverSrcRect(iw,ih,dw,dh,dx=0,dy=0,z=1){const s=Math.max(dw/iw,dh/ih)*z,vw=dw/s,vh=dh/s,mx=Math.max(0,(iw-vw)/2),my=Math.max(0,(ih-vh)/2),sx=(iw-vw)/2+Math.max(-mx,Math.min(mx,dx*mx)),sy=(ih-vh)/2+Math.max(-my,Math.min(my,dy*my));return{sx,sy,sw:vw,sh:vh};}

/* ===== NÃ—N å†…éƒ¨åˆ†å‰²ï¼ˆäº¤äº’ãƒŸãƒ©ãƒ¼ï¼‰ãƒ‘ã‚¿ãƒ¼ãƒ³ ===== */
function rebuildPattern(){
  if(!baseImg)return;
  const w=cv.width,h=cv.height;
  if(!patternCanvas){patternCanvas=document.createElement('canvas');patternCtx=patternCanvas.getContext('2d');}
  patternCanvas.width=w;patternCanvas.height=h;

  const t=performance.now();
  const dx=Math.sin(t*0.00023)*0.9,dy=Math.cos(t*0.00019)*0.9;
  const z=1+0.06*Math.sin(t*0.00011);
  const src=computeCoverSrcRect(baseImg.width,baseImg.height,w,h,dx,dy,z);

  const tw=w/gridN,th=h/gridN,sw=src.sw/gridN,sh=src.sh/gridN;
  patternCtx.clearRect(0,0,w,h);
  for(let gy=0;gy<gridN;gy++){
    for(let gx=0;gx<gridN;gx++){
      const dxp=gx*tw,dyp=gy*th,sx=src.sx+gx*sw,sy=src.sy+gy*sh;
      patternCtx.save();
      patternCtx.translate(dxp+tw/2,dyp+th/2);
      patternCtx.scale(gx%2?-1:1, gy%2?-1:1);
      patternCtx.drawImage(baseImg,sx,sy,sw,sh,-tw/2,-th/2,tw,th);
      patternCtx.restore();
    }
  }
}

/* ===== æ”¾å°„æç”»ï¼šå››è§’ã„æ ã®ä¸‹ã§ã€å¯¾è§’ã‚ˆã‚Šå¤§ãã„å††ç›¤ãŒå›è»¢ ===== */
function drawRadialFromPattern(){
  const w=cv.width,h=cv.height;
  ctx.clearRect(0,0,w,h);

  // ãƒˆãƒƒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é»’ã„æ¿ï¼ˆå››è§’ã„æ ï¼‰
  ctx.fillStyle='#000';
  ctx.fillRect(0,0,w,h);

  if(!patternCanvas) return;

  const cx=w/2, cy=h/2;
  const slice=(Math.PI*2)/segments;

  // â˜… å††ç›¤ã®åŠå¾„ï¼šå¿…ãš å¯¾è§’/2 ã‚’è¶…ãˆã‚‹ï¼ˆ= å››éš…ã®ä¸‹ã¾ã§åˆ°é”ï¼‰
  const R = Math.hypot(w,h) * 0.53;   // 0.53ã€œ0.60 ã§ãŠå¥½ã¿ã«
  const wedgeR = Math.hypot(w,h);     // æ‰‡ã¯å¯¾è§’ã¶ã‚“ä¼¸ã°ã™

  ctx.save();
  ctx.translate(cx,cy);

  // å††ã§ã‚¯ãƒªãƒƒãƒ—ï¼ˆã“ã®å††ã®ä¸­ã ã‘ã«æ”¾å°„ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æãï¼å††ç›¤ï¼‰
  ctx.beginPath();
  ctx.arc(0,0,R,0,Math.PI*2);
  ctx.clip();

  for(let i=0;i<segments;i++){
    ctx.save();
    ctx.rotate(i*slice + angle);

    // æ‰‡ï¼ˆä¸‰è§’æ‰‡å½¢ï¼‰ã‚¯ãƒªãƒƒãƒ— â†’ å†† âˆ© æ‰‡
    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.lineTo(wedgeR, -wedgeR*Math.tan(slice/2));
    ctx.lineTo(wedgeR,  wedgeR*Math.tan(slice/2));
    ctx.closePath();
    ctx.clip();

    // å¶æ•°ç•ªãƒŸãƒ©ãƒ¼
    const flip = (i%2===1) ? -1 : 1;
    ctx.scale(flip,1);

    // å††ã®ä¸­ã« NÃ—N ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è²¼ã‚‹
    ctx.drawImage(patternCanvas, -w/2, -h/2, w, h);

    ctx.restore();
  }

  ctx.restore();

  // å›è»¢é€Ÿåº¦ï¼ˆã‚»ã‚°ãƒ¡ãƒ³ãƒˆå¤šã„ï¼ã¡ã‚‡ã„é…ãï¼‰
  const spd = 0.0025*(24/Math.max(12,segments));
  angle += spd;
}

/* ===== ã‚¯ãƒªãƒƒã‚¯åå¿œï¼ˆãƒ‘ãƒ«ã‚¹ï¼‹ä»»æ„ãƒãƒ£ã‚¤ãƒ ï¼‰ ===== */
let pulseT=0;
cv.addEventListener('click',async()=>{
  if(document.getElementById('chimeOnCanvas').checked){
    try{await ensureAudioCtx();chimeAudio.currentTime=0;await chimeAudio.play().catch(()=>playBeep());}catch{}
  }
  pulseT=performance.now(); if(navigator.vibrate) navigator.vibrate(10);
});
function drawPulse(){
  if(!pulseT) return;
  const e=(performance.now()-pulseT)/400;
  if(e>1){pulseT=0;return;}
  ctx.save();
  ctx.globalCompositeOperation='screen';
  ctx.globalAlpha=1-e;
  const w=cv.width,h=cv.height;
  const g=ctx.createRadialGradient(w/2,h/2,0,w/2,h/2,Math.max(w,h)*0.6*e);
  g.addColorStop(0,'rgba(255,255,255,0.35)');
  g.addColorStop(1,'rgba(255,255,255,0)');
  ctx.fillStyle=g;
  ctx.fillRect(0,0,w,h);
  ctx.restore();
}

/* ===== ãƒ«ãƒ¼ãƒ— ===== */
function tick(){ if(baseImg) rebuildPattern(); drawRadialFromPattern(); drawPulse(); requestAnimationFrame(tick); }

/* ===== ç”»åƒï¼ˆå˜ä½“/ãƒ•ã‚©ãƒ«ãƒ€/D&D/ãƒ†ã‚¹ãƒˆï¼‰ ===== */
function loadImageFromFile(f){ if(!f) return; const u=URL.createObjectURL(f),im=new Image(); im.onload=()=>{baseImg=im;URL.revokeObjectURL(u);}; im.src=u; }
document.getElementById('imgFile').onchange=e=>loadImageFromFile(e.target.files[0]);
['dragenter','dragover'].forEach(t=>cv.addEventListener(t,e=>e.preventDefault()));
cv.addEventListener('drop',e=>{e.preventDefault();const f=e.dataTransfer.files&&e.dataTransfer.files[0]; if(f&&f.type.startsWith('image/')) loadImageFromFile(f);});
document.getElementById('clearImg').onclick=()=>{baseImg=null;patternCanvas=null;};

const dirPicker=document.getElementById('dirPicker'),prevBtn=document.getElementById('prevBtn'),nextBtn=document.getElementById('nextBtn'),JA=new Intl.Collator('ja',{numeric:true,sensitivity:'base'});
dirPicker.onchange=e=>{fileList=Array.from(e.target.files).filter(f=>/^image\//.test(f.type));fileList.sort((a,b)=>JA.compare(a.name,b.name));fileIdx=-1;nextImage();};
function nextImage(){ if(!fileList.length) return; fileIdx=(fileIdx+1)%fileList.length; loadImageFromFile(fileList[fileIdx]); }
function prevImage(){ if(!fileList.length) return; fileIdx=(fileIdx-1+fileList.length)%fileList.length; loadImageFromFile(fileList[fileIdx]); }
nextBtn.onclick=nextImage; prevBtn.onclick=prevImage;
window.addEventListener('keydown',e=>{ if(e.key==='ArrowRight') nextImage(); if(e.key==='ArrowLeft') prevImage(); });

function loadBuiltInTestImage(){
  const svg=`<svg xmlns="http://www.w3.org/2000/svg" width="1024" height="1024"><defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#fff"/><stop offset="50%" stop-color="#f7b65a"/><stop offset="100%" stop-color="#3aa0ff"/></linearGradient><pattern id="p" width="64" height="64" patternUnits="userSpaceOnUse"><rect width="64" height="64" fill="url(#g)"/><path d="M0 32 H64 M32 0 V64" stroke="rgba(0,0,0,.18)" stroke-width="2"/></pattern></defs><rect width="1024" height="1024" fill="url(#p)"/></svg>`;
  const url='data:image/svg+xml;utf8,'+encodeURIComponent(svg);
  const im=new Image(); im.onload=()=>{baseImg=im;}; im.src=url;
}
document.getElementById('testImgBtn').onclick=loadBuiltInTestImage;

/* ===== éŸ³æ¥½ï¼ˆå˜ä½“/ãƒ•ã‚©ãƒ«ãƒ€ï¼šæ•°å­—â†’50éŸ³ï¼‰ ===== */
document.getElementById('musicFile').onchange=e=>{const f=e.target.files[0]; if(f) music.src=URL.createObjectURL(f);};
document.getElementById('musicPlay').onclick=async()=>{await ensureAudioCtx(); if(music.paused) await music.play(); else music.pause();};

const musicDir=document.getElementById('musicDir'),prevTrack=document.getElementById('prevTrack'),nextTrack=document.getElementById('nextTrack'),trackInfo=document.getElementById('trackInfo');
const collatorJA=new Intl.Collator('ja',{numeric:true,sensitivity:'base'}),AUDIO_OK=new Set(['.mp3','.m4a','.wav','.ogg','.aac','.flac']);
let playlist=[],trackIdx=-1;
function isAudioFile(n){const i=n.lastIndexOf('.'); return AUDIO_OK.has((i>=0?n.slice(i).toLowerCase():''));}
function setTrackInfo(){trackInfo.textContent=(trackIdx>=0&&playlist[trackIdx])?`${trackIdx+1}/${playlist.length}  ${playlist[trackIdx].name}`:'';}
function loadTrack(i){ if(!playlist.length) return; trackIdx=(i+playlist.length)%playlist.length; const f=playlist[trackIdx]; music.src=URL.createObjectURL(f); setTrackInfo(); }
async function playCurrent(){ try{ await ensureAudioCtx(); await music.play(); }catch{} }
function nextT(){ if(!playlist.length) return; loadTrack(trackIdx+1); playCurrent(); }
function prevT(){ if(!playlist.length) return; loadTrack(trackIdx-1); playCurrent(); }
musicDir.onchange=e=>{const files=Array.from(e.target.files).filter(f=>isAudioFile(f.name)); files.sort((a,b)=>collatorJA.compare(a.name,b.name)); playlist=files; if(playlist.length){loadTrack(0); playCurrent();} else {trackIdx=-1; setTrackInfo();}};
prevTrack.onclick=prevT; nextTrack.onclick=nextT; music.onended=nextT;
window.addEventListener('keydown',e=>{ if(e.key==='ArrowRight') nextT(); if(e.key==='ArrowLeft') prevT(); });

/* ===== ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ & ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ ===== */
const segs=document.getElementById('segs'),segsV=document.getElementById('segsV'),gridNInput=document.getElementById('gridN'),gridNV=document.getElementById('gridNV');
segs.oninput=()=>{segments=+segs.value;segsV.textContent=segments;};
gridNInput.oninput=()=>{gridN=+gridNInput.value;gridNV.textContent=gridN;};

function fitCanvas(){
  const dpr=Math.max(1,Math.min(2,window.devicePixelRatio||1));
  const size=Math.min(window.innerWidth,window.innerHeight-80);
  cv.style.width=cv.style.height=size+'px';
  cv.width=Math.floor(size*dpr);
  cv.height=Math.floor(size*dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
addEventListener('resize',fitCanvas); fitCanvas();
loadBuiltInTestImage(); requestAnimationFrame(tick);

/* ===== PWA: SWç™»éŒ²ï¼ˆhttps/localhostã®ã¿ï¼‰ ===== */
(function(){
  const isLocalhost=['localhost','127.0.0.1'].includes(location.hostname);
  if('serviceWorker' in navigator && (isLocalhost || location.protocol==='https:')){
    navigator.serviceWorker.register('./sw.js?v=14').catch(e=>console.warn('SW register failed:',e));
  }
})();
</script>
</body>
</html>
