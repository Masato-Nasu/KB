<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>万華鏡（正方形・放射状）PWA</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json?v=1">
  <meta name="theme-color" content="#111318">
  <link rel="icon" href="./icon-192.png" type="image/png">
  <link rel="apple-touch-icon" href="./icon-192.png">

  <style>
    :root{--bg:#0b0d11;--fg:#d7e4ff;--muted:#86a2c9}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    #app{position:fixed;inset:0;display:grid;grid-template-rows:1fr auto}
    canvas{width:100%;height:100%;background:#000;display:block}
    .bar{display:flex;gap:.6rem;flex-wrap:wrap;align-items:center;justify-content:center;padding:.7rem;background:linear-gradient(180deg, rgba(14,18,24,.6), rgba(14,18,24,.95));backdrop-filter:blur(6px);border-top:1px solid #1e2733}
    .btn{background:#0f1a27;border:1px solid #263244;color:var(--fg);padding:.55rem .8rem;border-radius:.8rem;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .pill{font-size:.9rem;color:var(--muted)}
    .status{position:fixed;left:.6rem;top:.3rem;color:#9cc3ff;font-family:ui-monospace,Consolas,monospace;font-size:.85rem;opacity:.9;max-width:90vw;white-space:pre-wrap}
    input[type=file]{display:none}
    label.file{cursor:pointer}
    .toggle{display:inline-flex;align-items:center;gap:.35rem}
  </style>
</head>
<body>
<div id="app">
  <canvas id="cv" width="1024" height="1024" aria-label="kaleidoscope canvas"></canvas>

  <div class="bar">
    <input id="imgFile" type="file" accept="image/*">
    <label for="imgFile" class="btn file">📷 画像を選択</label>
    <button id="testImgBtn" class="btn">🧪 テスト画像</button>
    <button id="clearImg" class="btn">画像クリア</button>

    <span class="pill">（ドラッグ&ドロップでも読み込み可）</span>

    <input id="audFile" type="file" accept="audio/*">
    <label for="audFile" class="btn file">🎵 音楽ファイル</label>
    <button id="playBtn" class="btn">▶ 再生/一時停止</button>

    <button id="enableBtn" class="btn">🔔 センサーと音を有効化</button>

    <span class="toggle">
      <label>セグメント</label>
      <input id="segs" type="range" min="6" max="48" value="24">
      <span id="segsV">24</span>
    </span>
  </div>
</div>

<pre class="status" id="status"></pre>

<script>
/* ===== PWA: Service Worker register (https/localhost only) ===== */
(function(){
  const isLocalhost = ['localhost','127.0.0.1'].includes(location.hostname);
  if ('serviceWorker' in navigator && (isLocalhost || location.protocol==='https:')) {
    navigator.serviceWorker.register('./sw.js?v=7').catch(e=>{
      console.warn('SW register failed:', e);
      const s=document.getElementById('status'); if(s) s.textContent='SW登録失敗: '+e;
    });
  } else {
    const s=document.getElementById('status'); if(s) s.textContent='SW未登録: https/localhost でのみ有効（file:// 直開き不可）';
  }
})();

/* ===== Canvas Kaleidoscope (square frame, radial mirror) ===== */
const cv = document.getElementById('cv');
const ctx = cv.getContext('2d');
let img = null;
let angle = 0;
let segments = 24;
let scale = 1.0;

function drawKaleido(){
  const w = cv.width, h = cv.height;
  ctx.clearRect(0,0,w,h);
  ctx.save();
  // 正方形フレーム（端まで描画）
  ctx.fillStyle = '#000';
  ctx.fillRect(0,0,w,h);

  if (img){
    const cx = w/2, cy = h/2;
    const radius = Math.max(w,h)*0.8;
    const slice = (Math.PI*2)/segments;

    for(let i=0;i<segments;i++){
      ctx.save();
      ctx.translate(cx, cy);
      ctx.rotate(i*slice + angle);

      // 三角扇形クリップ
      ctx.beginPath();
      ctx.moveTo(0,0);
      ctx.lineTo(radius, -radius*Math.tan(slice/2));
      ctx.lineTo(radius,  radius*Math.tan(slice/2));
      ctx.closePath();
      ctx.clip();

      // 偶数枚をミラー反転
      const flip = (i%2===1) ? -1 : 1;
      ctx.scale(flip*scale, scale);

      // 画像をカバー配置（中央寄せ）
      const iw = img.width, ih = img.height;
      const s = Math.max(w/iw, h/ih);
      ctx.drawImage(img, -iw*s/2, -ih*s/2, iw*s, ih*s);

      ctx.restore();
    }
  }

  ctx.restore();
  angle += 0.0025; // ゆっくり回転
  requestAnimationFrame(drawKaleido);
}
requestAnimationFrame(drawKaleido);

/* ===== 内蔵テスト画像（SVG生成 → data URL）===== */
function loadBuiltInTestImage(){
  const svg = `
  <svg xmlns="http://www.w3.org/2000/svg" width="1024" height="1024" viewBox="0 0 1024 1024">
    <defs>
      <radialGradient id="g" cx="50%" cy="50%" r="70%">
        <stop offset="0%" stop-color="#ffffff"/>
        <stop offset="40%" stop-color="#ffd266"/>
        <stop offset="70%" stop-color="#ff6ea8"/>
        <stop offset="100%" stop-color="#3aa0ff"/>
      </radialGradient>
      <pattern id="p" width="64" height="64" patternUnits="userSpaceOnUse">
        <rect width="64" height="64" fill="url(#g)"/>
        <circle cx="32" cy="32" r="12" fill="rgba(0,0,0,0.15)"/>
      </pattern>
    </defs>
    <rect width="1024" height="1024" fill="url(#p)"/>
    <!-- 放射状の線 -->
    <g stroke="rgba(0,0,0,0.3)" stroke-width="2">
      ${Array.from({length:72}).map((_,i)=>`<line x1="512" y1="512" x2="${512+520*Math.cos(i*5*Math.PI/180)}" y2="${512+520*Math.sin(i*5*Math.PI/180)}"/>`).join('')}
    </g>
  </svg>`;
  const url = 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
  const im = new Image();
  im.onload = ()=>{ img = im; };
  im.src = url;
}

/* ===== 画像読み込み（ファイル/ドラッグ&ドロップ/内蔵テスト）===== */
function loadImageFromFile(file){
  if(!file) return;
  const url = URL.createObjectURL(file);
  const im = new Image();
  im.onload = ()=>{ img = im; URL.revokeObjectURL(url); };
  im.src = url;
}
document.getElementById('imgFile').addEventListener('change', e=>{
  loadImageFromFile(e.target.files[0]);
});
['dragenter','dragover'].forEach(t=>{
  cv.addEventListener(t, e=>{e.preventDefault();});
});
cv.addEventListener('drop', e=>{
  e.preventDefault();
  const f = e.dataTransfer.files && e.dataTransfer.files[0];
  if (f && f.type.startsWith('image/')) loadImageFromFile(f);
});
document.getElementById('testImgBtn').addEventListener('click', loadBuiltInTestImage);
document.getElementById('clearImg').addEventListener('click', ()=>{ img = null; });

/* ===== セグメント調整 ===== */
const segs = document.getElementById('segs');
const segsV = document.getElementById('segsV');
segs.addEventListener('input', ()=>{
  segments = parseInt(segs.value,10);
  segsV.textContent = segments;
});

/* ===== Audio / Chime / Sensors ===== */
const statusEl = document.getElementById('status');
const audInput = document.getElementById('audFile');
const playBtn = document.getElementById('playBtn');
let audio = new Audio();
let audioCtx = null;
audio.loop = false;

audInput.addEventListener('change', e=>{
  const f = e.target.files[0];
  if (!f) return;
  audio.src = URL.createObjectURL(f);
});

async function ensureAudioCtx(){
  if (!audioCtx) {
    const AC = window.AudioContext || window.webkitAudioContext;
    audioCtx = new AC();
  }
  if (audioCtx.state === 'suspended') await audioCtx.resume();
}

playBtn.addEventListener('click', async ()=>{
  try {
    await ensureAudioCtx();
    if (audio.paused) { await audio.play(); }
    else { audio.pause(); }
  } catch (e) { statusEl.textContent = '再生失敗: ' + e; }
});

/* ---- チャイム（タップ & 端末を振る）---- */
function playChime(freq=880, dur=0.28){
  if (!audioCtx) return; // ユーザー操作後のみ有効
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = 'sine';
  o.frequency.value = freq;
  g.gain.value = 0.0;
  o.connect(g).connect(audioCtx.destination);
  const t = audioCtx.currentTime;
  g.gain.linearRampToValueAtTime(0.25, t + 0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, t + dur);
  o.start(t);
  o.stop(t + dur + 0.02);
}

// タップで必ず解錠＆チャイム
document.body.addEventListener('click', ()=>{
  ensureAudioCtx().then(()=>playChime());
});

// センサー有効化（iOS許可→devicemotion）
document.getElementById('enableBtn').addEventListener('click', async ()=>{
  try {
    await ensureAudioCtx();
    if ('DeviceMotionEvent' in window && typeof DeviceMotionEvent.requestPermission === 'function') {
      const res = await DeviceMotionEvent.requestPermission();
      if (res !== 'granted') { statusEl.textContent = 'センサー権限が拒否されました'; return; }
    }
    window.addEventListener('devicemotion', onMotion, {passive:true});
    statusEl.textContent = 'センサーと音を有効化しました（強く振るとチャイム）';
    playChime(990, 0.22);
  } catch (e) {
    statusEl.textContent = '有効化エラー: ' + e;
  }
});

// シェイク検出でチャイム
let lastShakeAt = 0;
function onMotion(e){
  const a = e.accelerationIncludingGravity;
  if (!a) return;
  const mag = Math.hypot(a.x||0,a.y||0,a.z||0);
  const now = performance.now();
  if (mag > 22 && (now - lastShakeAt) > 600) {
    lastShakeAt = now;
    playChime(880 + Math.random()*120, 0.25 + Math.random()*0.07);
    // 回転に少しランダム変化
    angle += (Math.random() - 0.5) * 0.5;
  }
}

/* ===== 正方形で高精細にリサイズ ===== */
function fitCanvas(){
  const dpr = Math.max(1, Math.min(2, window.devicePixelRatio||1));
  const size = Math.min(window.innerWidth, window.innerHeight-72);
  cv.style.width = cv.style.height = size + 'px';
  cv.width = Math.floor(size * dpr);
  cv.height = Math.floor(size * dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
addEventListener('resize', fitCanvas); fitCanvas();

/* ===== 起動時に内蔵テスト画像を自動ロード ===== */
loadBuiltInTestImage();
</script>
</body>
</html>
