<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
<title>Radial Kaleidoscope — Slow Spin Version</title>
<link rel="icon" href="./babyface-192.png" type="image/png" />
<style>
  html,body{height:100%;margin:0;overflow:hidden;background:#0b0b10;color:#fff;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
  body{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:16px;gap:16px}
  canvas{width:100%;max-width:560px;aspect-ratio:1/1;background:#000;
    box-shadow:0 0 60px rgba(0,0,0,.7);opacity:0;transition:opacity .6s ease;pointer-events:none}
  canvas.active{opacity:1;pointer-events:auto}
  #controls{width:100%;max-width:560px;display:flex;flex-direction:column;gap:8px}
  #lcd,button,label,select{
    height:46px;border-radius:10px;background:#0f0f12;border:1px solid #3a3a3f;color:#fff;
    display:flex;align-items:center;justify-content:center;cursor:pointer;
    font-family:ui-monospace,Menlo,Consolas,monospace;font-size:15px;padding:0 12px}
  #lcd{overflow:hidden}
  #lcd span{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%}
  .row{display:flex;gap:8px}
  .row>*{flex:1}
  input[type=file],audio{display:none}
  small.hint{opacity:.7}
</style>
</head>
<body>
<canvas id="cv" width="560" height="560" title="Tap or shake to spin"></canvas>

<div id="controls">
  <div id="lcd"><span>NO IMAGE — CLICK “SELECT IMAGE”</span></div>
  <div class="row">
    <label id="imgBtn">SELECT IMAGE</label>
    <select id="sectorSel"><option>8</option><option selected>12</option><option>16</option><option>24</option></select>
    <select id="ringSel"><option>3</option><option selected>5</option><option>7</option><option>9</option></select>
  </div>
  <div class="row">
    <label id="folderBtn">SELECT MUSIC FOLDER / FILES</label>
    <button id="playBtn">PLAY</button>
  </div>
  <div class="row">
    <button id="pauseBtn">PAUSE</button>
    <button id="prevBtn">PREV</button>
    <button id="nextBtn">NEXT</button>
  </div>
  <small class="hint">Tap/Click or gently shake your phone → the kaleidoscope spins slowly</small>
</div>

<audio id="player" preload="metadata" playsinline></audio>
<audio id="chime" src="./Sparkling Chime Sound.m4a" preload="auto"></audio>

<script>
const cv=document.getElementById('cv'),ctx=cv.getContext('2d');
const W=cv.width,H=cv.height,CX=W/2,CY=H/2;
const R2=Math.hypot(CX,CY);

const lcdSpan=document.querySelector('#lcd span');
const sectorSel=document.getElementById('sectorSel');
const ringSel=document.getElementById('ringSel');
let sectors=+sectorSel.value,rings=+ringSel.value;
sectorSel.onchange=()=>sectors=+sectorSel.value;
ringSel.onchange=()=>rings=+ringSel.value;

/* ==== Image ==== */
const imgBtn=document.getElementById('imgBtn');
const imgInput=document.createElement('input');
imgInput.type='file';imgInput.accept='image/*';
imgBtn.onclick=()=>imgInput.click();
let img=null,imgW=0,imgH=0,imgReady=false;
imgInput.onchange=e=>{
  const f=e.target.files?.[0];if(!f)return;
  const u=URL.createObjectURL(f);
  img=new Image();
  img.onload=()=>{imgW=img.naturalWidth;imgH=img.naturalHeight;imgReady=true;
    lcdSpan.textContent=`IMAGE: ${f.name}`;cv.classList.add('active');URL.revokeObjectURL(u);};
  img.src=u;
};

/* ==== Music ==== */
const player=document.getElementById('player');
let audioCtx,analyser,fftBins,playlist=[],urls=[],current=0;
let lvlLow=0,lvlHigh=0,smoothLow=0,smoothHigh=0;
function ensureAudio(){
  if(audioCtx)return;
  audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  const src=audioCtx.createMediaElementSource(player);
  analyser=audioCtx.createAnalyser();analyser.fftSize=2048;
  src.connect(analyser);analyser.connect(audioCtx.destination);
  fftBins=new Uint8Array(analyser.frequencyBinCount);
}
async function play(i=current){
  if(!playlist.length)return;
  current=(i+playlist.length)%playlist.length;
  player.src=urls[current];await player.play();ensureAudio();
  lcdSpan.textContent=`TRACK ${current+1}/${playlist.length}: ${playlist[current].name}`;
}
player.onended=()=>play(current+1);
const folderBtn=document.getElementById('folderBtn');
const audioInput=document.createElement('input');
audioInput.type='file';audioInput.accept='audio/*';audioInput.multiple=true;audioInput.webkitdirectory=true;
folderBtn.onclick=async()=>{
  try{
    if('showDirectoryPicker'in window){
      const h=await window.showDirectoryPicker({mode:'read'});
      const files=[];async function*walk(d){for await(const [n,ent]of d.entries()){if(ent.kind==='file')yield await ent.getFile();else if(ent.kind==='directory')yield*walk(ent);}}
      for await(const f of walk(h))files.push(f);
      loadFiles(files,h.name);
    }else audioInput.click();
  }catch{audioInput.click();}
};
audioInput.onchange=e=>loadFiles([...(e.target.files||[])]);
function loadFiles(files,label=''){
  playlist=files.filter(f=>(f.type&&f.type.startsWith('audio/'))||/\.(mp3|m4a|aac|wav|flac|ogg)$/i.test(f.name));
  urls=playlist.map(f=>URL.createObjectURL(f));
  lcdSpan.textContent=playlist.length?`LOADED ${playlist.length} FILES${label?' — '+label:''}`:'NO FILES';
}
document.getElementById('playBtn').onclick=()=>play();
document.getElementById('pauseBtn').onclick=()=>player.pause();
document.getElementById('nextBtn').onclick=()=>play(current+1);
document.getElementById('prevBtn').onclick=()=>play(current-1);

/* ==== Offscreen (動く背景) ==== */
const off=document.createElement('canvas'),octx=off.getContext('2d');
off.width=off.height=Math.max(W,H)*2.2;
function drawOff(t){
  if(!imgReady)return;
  const base=off.width;
  const coverS=Math.max(base/imgW,base/imgH);
  const zoom=1.12+0.06*Math.sin(t*0.35)+smoothLow*0.05;
  const sw=imgW/(coverS*zoom),sh=imgH/(coverS*zoom);
  const ax=0.5+0.45*Math.sin(t*0.18);
  const ay=0.5+0.45*Math.sin(t*0.23+1.3);
  const sx=(imgW-sw)*ax,sy=(imgH-sh)*ay;
  const rot=0.02*Math.sin(t*0.22)+smoothHigh*0.03;
  octx.setTransform(1,0,0,1,0,0);
  octx.clearRect(0,0,base,base);
  octx.translate(base/2,base/2);
  octx.rotate(rot);
  octx.drawImage(img,sx,sy,sw,sh,-sw/2,-sh/2,sw,sh);
  octx.setTransform(1,0,0,1,0,0);
}

/* ==== Radial Pattern ==== */
function clipWedgeAnnulus(outerR,innerR,halfAng){
  ctx.beginPath();
  ctx.arc(0,0,outerR,-halfAng,halfAng,false);
  ctx.arc(0,0,innerR,halfAng,-halfAng,true);
  ctx.closePath();ctx.clip();
}
function drawRadial(baseRot){
  ctx.save();
  ctx.translate(CX,CY);
  ctx.rotate(baseRot);
  const ang=2*Math.PI/sectors,half=ang/2;
  for(let i=0;i<sectors;i++){
    ctx.save();
    ctx.rotate(i*ang);
    for(let r=0;r<rings;r++){
      const inner=R2*(r/rings),outer=R2*((r+1)/rings);
      ctx.save();
      clipWedgeAnnulus(outer,inner,half);
      if(i%2)ctx.scale(-1,1);
      const K=1+r*0.10;
      ctx.drawImage(off,-off.width/2*K,-off.height/2*K,off.width*K,off.height*K);
      ctx.restore();
    }
    ctx.restore();
  }
  ctx.restore();
}

/* ==== Spin (クリック/シェイクでゆっくり回転) ==== */
let spinStart=0,spinFrom=0,spinTo=0;
const SPIN_MS=2800;       // ← ゆっくり時間
const SPIN_TURNS=0.5;     // ← 180度回転
const easeOutCubic=t=>1-Math.pow(1-t,3);
const lerp=(a,b,t)=>a+(b-a)*t;
function currentSpin(){
  if(!spinStart)return spinTo||0;
  const p=Math.min(1,(performance.now()-spinStart)/SPIN_MS);
  return lerp(spinFrom,spinTo,easeOutCubic(p));
}
function triggerSpin(turns=SPIN_TURNS){
  const nowAngle=currentSpin();
  spinFrom=nowAngle;
  spinTo=nowAngle+turns*2*Math.PI;
  spinStart=performance.now();
}
cv.addEventListener('click',()=>{
  triggerSpin();
  try{const c=document.getElementById('chime');c.currentTime=0;c.play();}catch{}
});

/* ==== Shake detection ==== */
let motionEnabled=false,lastShake=0;
function enableMotionIfNeeded(){
  if(motionEnabled)return;
  const DME=window.DeviceMotionEvent;
  if(DME&&typeof DME.requestPermission==='function'){
    DME.requestPermission().then(state=>{
      if(state==='granted'){attachShake();motionEnabled=true;}
    }).catch(()=>{});
  }else if('ondevicemotion'in window){attachShake();motionEnabled=true;}
}
function attachShake(){
  window.addEventListener('devicemotion',e=>{
    const a=e.accelerationIncludingGravity||e.acceleration;if(!a)return;
    const mag=Math.hypot(a.x||0,a.y||0,a.z||0);
    if(mag>18&&performance.now()-lastShake>1600){
      lastShake=performance.now();
      triggerSpin();
    }
  },{passive:true});
}
cv.addEventListener('pointerdown',enableMotionIfNeeded,{once:false});

/* ==== 色フェード ==== */
let tintStart=0,tintFrom=210,tintTo=210;
cv.addEventListener('click',()=>{
  tintFrom=tintTo;
  const choices=[210,260,315,30,90,150];
  tintTo=choices[(Math.random()*choices.length)|0];
  tintStart=performance.now();
});

/* ==== Loop ==== */
function hsl2rgb(h,s,l){
  h=(h%360+360)%360;s=Math.max(0,Math.min(1,s));l=Math.max(0,Math.min(1,l));
  const c=(1-Math.abs(2*l-1))*s,x=c*(1-Math.abs(((h/60)%2)-1)),m=l-c/2;
  let rr=0,gg=0,bb=0;
  if(h<60){rr=c;gg=x;}else if(h<120){rr=x;gg=c;}
  else if(h<180){gg=c;bb=x;}else if(h<240){gg=x;bb=c;}
  else if(h<300){rr=x;bb=c;}else{rr=c;bb=x;}
  return[(rr+m)*255,(gg+m)*255,(bb+m)*255];
}
let t0=performance.now();
(function loop(){
  const now=performance.now(),t=(now-t0)/1000;
  if(analyser){
    analyser.getByteFrequencyData(fftBins);
    const len=fftBins.length,nyq=audioCtx.sampleRate/2;
    let low=0,ln=0,high=0,hn=0;
    for(let i=0;i<len;i++){
      const f=i/len*nyq,v=fftBins[i]/255;
      if(f<250){low+=v;ln++;}else if(f>4000&&f<12000){high+=v;hn++;}
    }
    lvlLow=ln?low/ln:0;lvlHigh=hn?high/hn:0;
  }
  smoothLow=0.96*smoothLow+0.04*lvlLow;
  smoothHigh=0.96*smoothHigh+0.04*lvlHigh;

  drawOff(t);
  ctx.clearRect(0,0,W,H);
  drawRadial(currentSpin());

  ctx.save();ctx.lineWidth=8;ctx.strokeStyle='rgba(255,255,255,0.15)';
  ctx.strokeRect(0,0,W,H);ctx.restore();

  const dur=2600,p=Math.min(1,(performance.now()-tintStart)/dur);
  const hue=tintFrom+(((tintTo-tintFrom+540)%360)-180)*p;
  const sat=0.46+0.12*smoothHigh;
  const lig=0.52+0.03*Math.sin(t*0.3);
  const [r,g,b]=hsl2rgb(hue,sat,lig);
  ctx.save();
  ctx.globalCompositeOperation='soft-light';
  ctx.globalAlpha=0.55;
  ctx.fillStyle=`rgb(${r|0},${g|0},${b|0})`;
  ctx.fillRect(0,0,W,H);
  ctx.restore();

  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
