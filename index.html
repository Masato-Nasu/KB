<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>ä¸‡è¯é¡ Finalï¼ˆNÃ—N åˆ†å‰² â†’ å††å½¢æ”¾å°„ï¼æ ã¯å››è§’ï¼‰</title>

<link rel="manifest" href="./manifest.json?v=12">
<meta name="theme-color" content="#111318">
<link rel="icon" href="./icon-192.png" type="image/png">
<link rel="apple-touch-icon" href="./icon-192.png">

<style>
  :root{--bg:#0b0d11;--fg:#d7e4ff;--muted:#86a2c9}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  #app{position:fixed;inset:0;display:grid;grid-template-rows:1fr auto;justify-items:center;align-items:center}
  canvas{background:#000;display:block;box-shadow:0 0 0 1px #111 inset}
  .bar{width:100%;display:flex;gap:.6rem;flex-wrap:wrap;align-items:center;justify-content:center;padding:.7rem;background:linear-gradient(180deg, rgba(14,18,24,.6), rgba(14,18,24,.95));backdrop-filter:blur(6px);border-top:1px solid #1e2733}
  .btn{background:#0f1a27;border:1px solid #263244;color:var(--fg);padding:.55rem .8rem;border-radius:.8rem;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .pill{font-size:.9rem;color:var(--muted)}
  .status{position:fixed;left:.6rem;top:.3rem;color:#9cc3ff;font-family:ui-monospace,Consolas,monospace;font-size:.85rem;opacity:.9;max-width:92vw;white-space:pre-wrap;pointer-events:none}
  input[type=file]{display:none}
  label.file{cursor:pointer}
  .group{display:inline-flex;align-items:center;gap:.35rem}
  .toggle{display:inline-flex;align-items:center;gap:.35rem}
</style>
</head>
<body>
<div id="app">
  <canvas id="cv" width="1024" height="1024" aria-label="kaleidoscope canvas"></canvas>

  <div class="bar" id="ui">
    <!-- ç”»åƒ1æš or ãƒ•ã‚©ãƒ«ãƒ€ -->
    <input id="imgFile" type="file" accept="image/*">
    <label for="imgFile" class="btn file">ğŸ“· ç”»åƒ</label>

    <input id="dirPicker" type="file" webkitdirectory multiple accept="image/*">
    <label for="dirPicker" class="btn file">ğŸ“ ãƒ•ã‚©ãƒ«ãƒ€ï¼ˆç”»åƒï¼‰</label>

    <button id="prevBtn" class="btn">âŸµ å‰</button>
    <button id="nextBtn" class="btn">æ¬¡ âŸ¶</button>

    <button id="testImgBtn" class="btn">ğŸ§ª ãƒ†ã‚¹ãƒˆç”»åƒ</button>
    <button id="clearImg" class="btn">ç”»åƒã‚¯ãƒªã‚¢</button>
    <span class="pill">(D&Då¯ï¼â†â†’ã§åˆ‡æ›¿)</span>

    <!-- åˆ†å‰²ã¨æ”¾å°„ -->
    <div class="group">
      <label>åˆ†å‰² NÃ—N</label>
      <input id="gridN" type="range" min="1" max="32" value="12">
      <span id="gridNV">12</span>
    </div>
    <div class="group">
      <label>æ”¾å°„ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ</label>
      <input id="segs" type="range" min="6" max="72" value="24">
      <span id="segsV">24</span>
    </div>

    <!-- éŸ³æ¥½ï¼ˆå˜æ›²ï¼‰ -->
    <input id="musicFile" type="file" accept="audio/*">
    <label for="musicFile" class="btn file">ğŸµ éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«</label>
    <button id="musicPlay" class="btn">â–¶ å†ç”Ÿ/ä¸€æ™‚åœæ­¢</button>

    <!-- éŸ³æ¥½ï¼ˆãƒ•ã‚©ãƒ«ãƒ€ï¼‰ -->
    <input id="musicDir" type="file" webkitdirectory multiple accept="audio/*">
    <label for="musicDir" class="btn file">ğŸ“ ãƒ•ã‚©ãƒ«ãƒ€ï¼ˆéŸ³æ¥½ï¼‰</label>
    <button id="prevTrack" class="btn">âŸµ å‰ã®æ›²</button>
    <button id="nextTrack" class="btn">æ¬¡ã®æ›² âŸ¶</button>
    <span id="trackInfo" class="pill"></span>

    <!-- ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚¯ãƒªãƒƒã‚¯ã®æŒ™å‹• -->
    <label class="toggle">
      <input type="checkbox" id="chimeOnCanvas"> ğŸ””ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚¯ãƒªãƒƒã‚¯ã§Chime
    </label>
  </div>
</div>

<pre class="status" id="status"></pre>

<script>
/* ===== PWA: Service Worker register (https/localhost only) ===== */
(function(){
  const isLocalhost = ['localhost','127.0.0.1'].includes(location.hostname);
  if ('serviceWorker' in navigator && (isLocalhost || location.protocol==='https:')) {
    navigator.serviceWorker.register('./sw.js?v=12').catch(e=>{
      console.warn('SW register failed:', e);
      const s=document.getElementById('status'); if(s) s.textContent='SWç™»éŒ²å¤±æ•—: '+e;
    });
  } else {
    const s=document.getElementById('status'); if(s) s.textContent='SWæœªç™»éŒ²: https/localhost ã§ã®ã¿æœ‰åŠ¹ï¼ˆfile:// ç›´é–‹ãä¸å¯ï¼‰';
  }
})();

/* ===== Elements & State ===== */
const cv = document.getElementById('cv');
const ctx = cv.getContext('2d');
const statusEl = document.getElementById('status');

let baseImg = null;          // è¡¨ç¤ºä¸­ã®ç”»åƒ
let fileList = [];           // ç”»åƒãƒ•ã‚©ãƒ«ãƒ€ã®ä¸€è¦§
let fileIdx = -1;

let patternCanvas = null;    // NÃ—N å†…éƒ¨åˆ†å‰²ã®åˆæˆç”¨
let patternCtx = null;

let gridN = 12;              // NÃ—N
let segments = 24;           // æ”¾å°„
let angle = 0;

/* ===== Audioï¼ˆãƒãƒ£ã‚¤ãƒ ï¼†éŸ³æ¥½ï¼‰ ===== */
let audioCtx = null;
const chimeAudio = new Audio('https://raw.githubusercontent.com/Masato-Nasu/KB/main/Chime.mp3'); // æŒ‡å®šã®Chime
chimeAudio.preload = 'auto';
const music = new Audio(); music.loop = false;

async function ensureAudioCtx(){
  if (!audioCtx) {
    const AC = window.AudioContext || window.webkitAudioContext;
    audioCtx = new AC();
  }
  if (audioCtx.state === 'suspended') await audioCtx.resume();
}
function playBeep(freq=880, dur=0.18){
  if (!audioCtx) return;
  const o = audioCtx.createOscillator(), g = audioCtx.createGain();
  o.type='sine'; o.frequency.value=freq; g.gain.value=0;
  o.connect(g).connect(audioCtx.destination);
  const t=audioCtx.currentTime; g.gain.linearRampToValueAtTime(0.22,t+0.01);
  g.gain.exponentialRampToValueAtTime(0.0001,t+dur); o.start(t); o.stop(t+dur+0.02);
}

/* ===== ç”»åƒãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆcoverã§é»’å¸¯ãªã—ï¼‰ ===== */
function computeCoverSrcRect(imgW, imgH, destW, destH, driftX=0, driftY=0, zoom=1.0){
  const scale = Math.max(destW/imgW, destH/imgH) * zoom;
  const viewW = destW/scale, viewH = destH/scale;
  const maxX = Math.max(0, (imgW - viewW)/2);
  const maxY = Math.max(0, (imgH - viewH)/2);
  const sx = (imgW - viewW)/2 + Math.max(-maxX, Math.min(maxX, driftX*maxX));
  const sy = (imgH - viewH)/2 + Math.max(-maxY, Math.min(maxY, driftY*maxY));
  return {sx, sy, sw:viewW, sh:viewH};
}

/* ===== NÃ—N å†…éƒ¨åˆ†å‰²ï¼ˆäº¤äº’ãƒŸãƒ©ãƒ¼ï¼‰ ===== */
function rebuildPattern(){
  if (!baseImg) return;
  const w = cv.width, h = cv.height;
  if (!patternCanvas){ patternCanvas=document.createElement('canvas'); patternCtx=patternCanvas.getContext('2d'); }
  patternCanvas.width = w; patternCanvas.height = h;

  // ãƒ‰ãƒªãƒ•ãƒˆï¼†ã‚ºãƒ¼ãƒ ï¼ˆå¸¸ã«å‹•ãï¼‰
  const t = performance.now();
  const driftX = Math.sin(t*0.00023)*0.9, driftY = Math.cos(t*0.00019)*0.9;
  const zoom   = 1.0 + 0.06*Math.sin(t*0.00011);

  const src = computeCoverSrcRect(baseImg.width, baseImg.height, w, h, driftX, driftY, zoom);
  const tileW = w / gridN, tileH = h / gridN;
  const srcTileW = src.sw / gridN, srcTileH = src.sh / gridN;

  patternCtx.clearRect(0,0,w,h);
  for(let gy=0; gy<gridN; gy++){
    for(let gx=0; gx<gridN; gx++){
      const dx = gx*tileW, dy = gy*tileH;
      const sxi = src.sx + gx*srcTileW, syi = src.sy + gy*srcTileH;
      patternCtx.save();
      patternCtx.translate(dx + tileW/2, dy + tileH/2);
      const flipX = (gx % 2 === 1) ? -1 : 1;
      const flipY = (gy % 2 === 1) ? -1 : 1;
      patternCtx.scale(flipX, flipY);
      patternCtx.drawImage(baseImg, sxi, syi, srcTileW, srcTileH, -tileW/2, -tileH/2, tileW, tileH);
      patternCtx.restore();
    }
  }
}

/* ===== æ”¾å°„æç”»ï¼ˆæ ï¼å››è§’ï¼å†…éƒ¨ï¼å††å½¢ã§å›è»¢ï¼‰ ===== */
function drawRadialFromPattern(){
  const w = cv.width, h = cv.height;
  ctx.clearRect(0,0,w,h);

  // å››è§’ã„èƒŒæ™¯ï¼ˆæ ã¯å››è§’ã®ã¾ã¾ï¼‰
  ctx.fillStyle = '#000';
  ctx.fillRect(0,0,w,h);

  if (!patternCanvas) return;

  const cx = w/2, cy = h/2;
  const slice = (Math.PI * 2) / segments;

  // å†…éƒ¨ã¯ã€Œæ­£æ–¹å½¢ã«å†…æ¥ã™ã‚‹å††ã€ã ã‘ã«æã
  const R = Math.min(w, h) * 0.5;

  ctx.save();
  ctx.translate(cx, cy);

  // å††ã‚¯ãƒªãƒƒãƒ—ï¼šå¤–å´ã¯çµ¶å¯¾ã«æã‹ã‚Œãªã„
  ctx.beginPath();
  ctx.arc(0, 0, R, 0, Math.PI*2);
  ctx.clip();

  const wedgeR = R * 1.05;  // å††ã®å†…å´ã«ååˆ†ãªé•·ã•

  for (let i = 0; i < segments; i++) {
    ctx.save();
    ctx.rotate(i * slice + angle);

    // æ‰‡ï¼ˆä¸‰è§’æ‰‡å½¢ï¼‰ã§ã•ã‚‰ã«ã‚¯ãƒªãƒƒãƒ— â†’ å††âˆ©æ‰‡
    ctx.beginPath();
    ctx.moveTo(0, 0);
    ctx.lineTo(wedgeR, -wedgeR * Math.tan(slice/2));
    ctx.lineTo(wedgeR,  wedgeR * Math.tan(slice/2));
    ctx.closePath();
    ctx.clip();

    // å¶æ•°ç•ªã‚’ãƒŸãƒ©ãƒ¼
    const flip = (i % 2 === 1) ? -1 : 1;
    ctx.scale(flip, 1);

    // ã‚½ãƒ¼ã‚¹ã¯ NÃ—N ã«åˆ†å‰²ã—ãŸ patternCanvas
    ctx.drawImage(patternCanvas, -w/2, -h/2, w, h);

    ctx.restore();
  }

  ctx.restore();

  // å›è»¢
  const speed = 0.0025 * (24 / Math.max(12, segments));
  angle += speed;
}

/* ===== ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å¯è¦–ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆãƒ‘ãƒ«ã‚¹ï¼‰ï¼‹ä»»æ„ãƒãƒ£ã‚¤ãƒ  ===== */
let pulseT = 0;
cv.addEventListener('click', async ()=>{
  if (document.getElementById('chimeOnCanvas').checked){
    try{ await ensureAudioCtx(); chimeAudio.currentTime=0; await chimeAudio.play().catch(()=>playBeep()); }catch{}
  }
  pulseT = performance.now();
  if (navigator.vibrate) navigator.vibrate(10);
});
function drawPulse(){
  if (!pulseT) return;
  const elapsed = (performance.now()-pulseT)/400; // 0â†’1
  if (elapsed>1){ pulseT=0; return; }
  ctx.save();
  ctx.globalCompositeOperation='screen';
  ctx.globalAlpha = 1-elapsed;
  const w=cv.width,h=cv.height;
  const grd=ctx.createRadialGradient(w/2,h/2,0,w/2,h/2,Math.max(w,h)*0.6*elapsed);
  grd.addColorStop(0,'rgba(255,255,255,0.35)');
  grd.addColorStop(1,'rgba(255,255,255,0)');
  ctx.fillStyle=grd;
  ctx.fillRect(0,0,w,h);
  ctx.restore();
}

/* ===== ãƒ«ãƒ¼ãƒ— ===== */
function tick(){
  if (baseImg) rebuildPattern();
  drawRadialFromPattern();
  drawPulse();
  requestAnimationFrame(tick);
}

/* ===== å˜æšç”»åƒãƒ»ç”»åƒãƒ•ã‚©ãƒ«ãƒ€ ===== */
function loadImageFromFile(file){
  if(!file) return;
  const url = URL.createObjectURL(file);
  const im = new Image();
  im.onload = ()=>{ baseImg = im; URL.revokeObjectURL(url); };
  im.src = url;
}
document.getElementById('imgFile').addEventListener('change', e=>loadImageFromFile(e.target.files[0]));
['dragenter','dragover'].forEach(t=>cv.addEventListener(t, e=>e.preventDefault()));
cv.addEventListener('drop', e=>{
  e.preventDefault();
  const f = e.dataTransfer.files && e.dataTransfer.files[0];
  if (f && f.type.startsWith('image/')) loadImageFromFile(f);
});
document.getElementById('clearImg').addEventListener('click', ()=>{ baseImg = null; patternCanvas = null; });

const dirPicker = document.getElementById('dirPicker');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const JA = new Intl.Collator('ja', { numeric:true, sensitivity:'base' });

dirPicker.addEventListener('change', e=>{
  fileList = Array.from(e.target.files).filter(f=>/^image\//.test(f.type));
  fileList.sort((a,b)=>JA.compare(a.name,b.name)); // æ•°å­—æ˜‡é †â†’50éŸ³é †
  fileIdx = -1;
  nextImage();
});
function nextImage(){
  if (!fileList.length) return;
  fileIdx = (fileIdx+1)%fileList.length;
  loadImageFromFile(fileList[fileIdx]);
}
function prevImage(){
  if (!fileList.length) return;
  fileIdx = (fileIdx-1+fileList.length)%fileList.length;
  loadImageFromFile(fileList[fileIdx]);
}
nextBtn.addEventListener('click', nextImage);
prevBtn.addEventListener('click', prevImage);
window.addEventListener('keydown', e=>{
  if (e.key==='ArrowRight') nextImage();
  if (e.key==='ArrowLeft')  prevImage();
});

/* ===== å†…è”µãƒ†ã‚¹ãƒˆç”»åƒ ===== */
function loadBuiltInTestImage(){
  const svg = `
  <svg xmlns="http://www.w3.org/2000/svg" width="1024" height="1024" viewBox="0 0 1024 1024">
    <defs>
      <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0%" stop-color="#fff"/>
        <stop offset="50%" stop-color="#f7b65a"/>
        <stop offset="100%" stop-color="#3aa0ff"/>
      </linearGradient>
      <pattern id="p" width="64" height="64" patternUnits="userSpaceOnUse">
        <rect width="64" height="64" fill="url(#g)"/>
        <path d="M0 32 H64 M32 0 V64" stroke="rgba(0,0,0,.18)" stroke-width="2"/>
      </pattern>
    </defs>
    <rect width="1024" height="1024" fill="url(#p)"/>
  </svg>`;
  const url = 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
  const im = new Image();
  im.onload = ()=>{ baseImg = im; };
  im.src = url;
}
document.getElementById('testImgBtn').addEventListener('click', loadBuiltInTestImage);

/* ===== å˜æ›²éŸ³æ¥½ ===== */
document.getElementById('musicFile').addEventListener('change', e=>{
  const f = e.target.files[0];
  if (!f) return;
  music.src = URL.createObjectURL(f);
});
document.getElementById('musicPlay').addEventListener('click', async ()=>{
  await ensureAudioCtx();
  try{ if (music.paused) await music.play(); else music.pause(); }
  catch(e){ statusEl.textContent = 'éŸ³æ¥½å†ç”Ÿã‚¨ãƒ©ãƒ¼: ' + e; }
});

/* ===== éŸ³æ¥½ãƒ•ã‚©ãƒ«ãƒ€ï¼ˆæ•°å­—â†’50éŸ³ï¼‰ ===== */
const musicDir = document.getElementById('musicDir');
const prevTrackBtn = document.getElementById('prevTrack');
const nextTrackBtn = document.getElementById('nextTrack');
const trackInfo = document.getElementById('trackInfo');
const collatorJA = new Intl.Collator('ja', { numeric:true, sensitivity:'base' });
const AUDIO_OK = new Set(['.mp3','.m4a','.wav','.ogg','.aac','.flac']);

let playlist = [];   // File[]
let trackIdx = -1;

function isAudioFile(name){
  const i = name.lastIndexOf('.'); const ext = i>=0 ? name.slice(i).toLowerCase() : '';
  return AUDIO_OK.has(ext);
}
function setTrackInfo(){
  trackInfo.textContent = (trackIdx>=0 && playlist[trackIdx]) ? `${trackIdx+1}/${playlist.length}  ${playlist[trackIdx].name}` : '';
}
function loadTrack(i){
  if (!playlist.length) return;
  trackIdx = (i + playlist.length) % playlist.length;
  const file = playlist[trackIdx];
  music.src = URL.createObjectURL(file);
  setTrackInfo();
}
async function playCurrent(){
  try { await ensureAudioCtx(); await music.play(); } catch {}
}
function nextTrack(){ if (!playlist.length) return; loadTrack(trackIdx+1); playCurrent(); }
function prevTrack(){ if (!playlist.length) return; loadTrack(trackIdx-1); playCurrent(); }

musicDir.addEventListener('change', e=>{
  const files = Array.from(e.target.files).filter(f=>isAudioFile(f.name));
  files.sort((a,b)=>collatorJA.compare(a.name,b.name)); // æ•°å­—æ˜‡é †â†’50éŸ³é †
  playlist = files;
  if (playlist.length){ loadTrack(0); playCurrent(); } else { trackIdx=-1; setTrackInfo(); }
});
prevTrackBtn.addEventListener('click', prevTrack);
nextTrackBtn.addEventListener('click', nextTrack);
music.addEventListener('ended', nextTrack);
window.addEventListener('keydown', e=>{
  if (e.key==='ArrowRight') nextTrack();
  if (e.key==='ArrowLeft')  prevTrack();
});

/* ===== ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ & ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ ===== */
const segs = document.getElementById('segs'), segsV=document.getElementById('segsV');
const gridNInput = document.getElementById('gridN'), gridNV=document.getElementById('gridNV');
segs.addEventListener('input', ()=>{ segments=+segs.value; segsV.textContent=segments; });
gridNInput.addEventListener('input', ()=>{ gridN=+gridNInput.value; gridNV.textContent=gridN; });

function fitCanvas(){
  const dpr = Math.max(1, Math.min(2, window.devicePixelRatio||1));
  const size = Math.min(window.innerWidth, window.innerHeight-80);
  cv.style.width = cv.style.height = size + 'px';
  cv.width = Math.floor(size * dpr);
  cv.height = Math.floor(size * dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
addEventListener('resize', fitCanvas); fitCanvas();

/* ===== Boot ===== */
loadBuiltInTestImage();   // èµ·å‹•æ™‚ã‹ã‚‰çµµãŒå‡ºã‚‹
requestAnimationFrame(tick);
</script>
</body>
</html>
