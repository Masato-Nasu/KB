<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Square Radiant Player v2</title>

<!-- ★ PWA最小追加（既存 v13 に合わせる） -->
<link rel="manifest" href="./manifest.json?v=13">
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js?v=13');
  }
</script>

<style>
  :root{
    --bg:#0e0f12; --panel:#111418; --text:#e8e9ee; --muted:#8b90a1;
  }
  html,body{
    height:100%;margin:0;
    background:var(--bg);color:var(--text);
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
  }
  .wrap{display:flex;flex-direction:column;align-items:center;gap:10px;min-height:100%}
  header{width:100%;max-width:1100px;padding:10px 14px;box-sizing:border-box;color:var(--muted)}
  .stage{position:relative;display:grid;place-items:center;width:100%;max-width:1100px;aspect-ratio:1;background:#000;border-radius:12px;cursor:pointer;overflow:hidden}
  canvas{max-width:100%;max-height:100%;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.45);transition:filter 1.2s ease;}
  .flash{filter:brightness(2);transition:filter 0.2s ease;}
  .controls{
    display:flex;flex-wrap:wrap;gap:8px;
    justify-content:center;align-items:center;
    padding:12px;background:var(--panel);
    border-radius:12px;margin:6px;max-width:1100px
  }
  .btn{
    appearance:none;border:0;border-radius:10px;
    background:#171a20;color:#eaeef8;
    padding:10px 12px;display:inline-flex;
    align-items:center;gap:8px;cursor:pointer
  }
  .btn:active{transform:translateY(1px)}
</style>
</head>
<body>
<div class="wrap">
  <header>クリックでチャイム＋長い余韻。前後曲ボタン・自動再生対応。</header>
  <div class="stage" id="stage"><canvas id="cv"></canvas></div>
  <div class="controls">
    <label class="btn">🖼 画像ファイル<input id="imgFile" type="file" accept="image/*" hidden></label>
    <label class="btn">🎵 音楽フォルダ<input id="audDir" type="file" webkitdirectory directory multiple accept="audio/*" hidden></label>
    <button id="prev" class="btn">← 前</button>
    <button id="play" class="btn">▶ / ❚❚</button>
    <button id="next" class="btn">次 →</button>
  </div>
</div>

<script>
(() => {
  const cv = document.getElementById('cv');
  const ctx = cv.getContext('2d');
  const stage = document.getElementById('stage');

  // === 画像 ===
  let currentImage = null;
  document.getElementById('imgFile').addEventListener('change', async e=>{
    const f = e.target.files?.[0];
    if(!f) return;
    const url = URL.createObjectURL(f);
    const img = await createImageBitmap(await (await fetch(url)).blob());
    URL.revokeObjectURL(url);
    currentImage = img;
  });

  // === 音楽 ===
  let audList = [], audIdx = 0;
  let audio = new Audio();
  let actx, analyser, data;
  let playing = false;

  function ensureAudio(){
    if(actx) return;
    actx = new (window.AudioContext||window.webkitAudioContext)();
    const src = actx.createMediaElementSource(audio);
    analyser = actx.createAnalyser();
    analyser.fftSize = 512;
    data = new Uint8Array(analyser.frequencyBinCount);
    src.connect(analyser).connect(actx.destination);
  }

  function naturalSort(a,b){ return a.name.localeCompare(b.name,'ja',{numeric:true}); }

  document.getElementById('audDir').addEventListener('change', async e=>{
    ensureAudio();
    audList = [...e.target.files].filter(f=>f.type.startsWith('audio/')).sort(naturalSort);
    audIdx = 0;
    if(audList.length){ playIndex(audIdx); }
  });

  function playIndex(i){
    if(!audList.length) return;
    const file = audList[i];
    audio.src = URL.createObjectURL(file);
    audio.play();
    playing = true;
  }

  // 次・前
  document.getElementById('next').addEventListener('click',()=>{
    if(!audList.length) return;
    audIdx = (audIdx + 1) % audList.length;
    playIndex(audIdx);
  });
  document.getElementById('prev').addEventListener('click',()=>{
    if(!audList.length) return;
    audIdx = (audIdx - 1 + audList.length) % audList.length;
    playIndex(audIdx);
  });

  // 自動次曲
  audio.addEventListener('ended', ()=>{
    if(audList.length){
      audIdx = (audIdx + 1) % audList.length;
      playIndex(audIdx);
    }
  });

  // 再生/一時停止
  document.getElementById('play').addEventListener('click', async ()=>{
    ensureAudio();
    if(actx.state==='suspended') await actx.resume();
    if(audio.paused){ audio.play(); playing=true; } else { audio.pause(); playing=false; }
  });

  // === チャイム音 ===
  const chime = new Audio("./Chime.mp3");
  chime.volume = 0.5;

  // === クリック反応（フラッシュ時間のみ短縮） ===
  stage.addEventListener('click', ()=>{
    chime.currentTime = 0;
    chime.play();
    cv.classList.add('flash');
    setTimeout(()=>cv.classList.remove('flash'), 600); // ← 1200ms から短縮
  });

  // === Canvas sizing ===
  function fit(){
    const s = Math.min(window.innerWidth, window.innerHeight)-40;
    cv.width = cv.height = Math.max(300,Math.floor(s));
  }
  window.addEventListener('resize',fit,{passive:true});
  fit();

  // === 放射描画（オリジナル完全維持） ===
  let t=0;
  function draw(){
    const w=cv.width,h=cv.height;
    ctx.clearRect(0,0,w,h);
    ctx.fillStyle="#000"; ctx.fillRect(0,0,w,h);

    if(currentImage){
      const SEGS=80;
      const slice=(Math.PI*2)/SEGS;
      const N=24;
      const plateSide=Math.min(w,h)*1.8;
      const half=plateSide/2;
      const step=plateSide/N;
      const uStep=currentImage.width/N;
      const vStep=currentImage.height/N;
      const wedgeR=Math.hypot(half,half)*1.1;

      ctx.save();
      ctx.translate(w/2,h/2);
      ctx.rotate(t);

      for(let i=0;i<SEGS;i++){
        ctx.save();
        ctx.rotate(i*slice);
        ctx.beginPath();
        ctx.moveTo(0,0);
        const dy=wedgeR*Math.tan(slice/2);
        ctx.lineTo(wedgeR,-dy);
        ctx.lineTo(wedgeR,dy);
        ctx.closePath();
        ctx.clip();

        for(let y=0;y<N;y++){
          for(let x=0;x<N;x++){
            const sx=(x*uStep+(t*40+i*13)%uStep)%currentImage.width;
            const sy=(y*vStep+(t*25+i*17)%vStep)%vStep%currentImage.height;
            ctx.drawImage(currentImage,sx,sy,uStep,vStep,-half+x*step,-half+y*step,step,step);
          }
        }
        ctx.restore();
      }
      ctx.restore();

      // 中央ウィンドウ
      const side=Math.min(w,h)*0.8;
      ctx.save();
      ctx.globalCompositeOperation="destination-in";
      ctx.beginPath();
      ctx.rect((w-side)/2,(h-side)/2,side,side);
      ctx.fill();
      ctx.restore();
    }

    // 音量ブースト
    let boost=0;
    if(analyser && playing){
      analyser.getByteTimeDomainData(data);
      let sum=0; for(let i=0;i<data.length;i++){ const d=(data[i]-128)/128; sum+=d*d; }
      const rms=Math.sqrt(sum/data.length);
      boost=rms*0.008;
    }

    t += 0.0025 + boost;
    requestAnimationFrame(draw);
  }
  draw();
})();
</script>
</body>
</html>
