<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Silk Orbits — minimal audio-reactive</title>
<link rel="manifest" href="./manifest.json?v=1">
<style>
  :root{ --bg:#0b0c10; --panel:#0f1117; --text:#e8e9ee; --muted:#8b90a1; }
  html,body{ height:100%; margin:0; background:var(--bg); color:var(--text);
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif; }
  .wrap{display:flex;flex-direction:column;align-items:center;gap:12px;min-height:100%}
  .stage{position:relative;display:grid;place-items:center;width:100%;max-width:1100px;aspect-ratio:1;background:#000;border-radius:18px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.5)}
  canvas{width:100%;height:100%;display:block}
  .controls{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;align-items:center;
    padding:12px;background:var(--panel);border-radius:12px;margin:8px;max-width:1100px}
  .btn{appearance:none;border:0;border-radius:12px;background:#171a20;color:#eaeef8;
    padding:10px 14px;display:inline-flex;align-items:center;gap:8px;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .range{display:inline-flex;align-items:center;gap:8px;background:#171a20;color:#eaeef8;border-radius:12px;padding:10px 12px}
  input[type="range"]{width:140px}
  .muted{color:var(--muted);font-size:12px;margin-top:-6px;text-align:center}
</style>
</head>
<body>
<div class="wrap">
  <div class="stage" id="stage"><canvas id="cv"></canvas></div>
  <div class="controls">
    <label class="btn">🎵 音楽フォルダ<input id="audDir" type="file" webkitdirectory directory multiple accept="audio/*" hidden></label>
    <button id="prev" class="btn">← 前</button>
    <button id="play" class="btn">▶ / ❚❚</button>
    <button id="next" class="btn">次 →</button>
    <div class="range">ライン数<input id="rings" type="range" min="6" max="36" step="1" value="18"></div>
    <div class="range">柔らかさ<input id="soft" type="range" min="0.1" max="0.9" step="0.02" value="0.5"></div>
  </div>
  <div class="muted">Silk Orbits v1: 画像依存を捨て、極細の発光リングで構成するミニマルなシステム。軽量・PWA・音反応。</div>
</div>

<script>
(() => {
  const cv = document.getElementById('cv');
  const ctx = cv.getContext('2d', { alpha:false });
  ctx.imageSmoothingEnabled = true;
  const stage = document.getElementById('stage');
  const ringsUI = document.getElementById('rings');
  const softUI  = document.getElementById('soft');

  // ===== Audio minimal =====
  let audList=[], audIdx=0, audio=new Audio(); audio.preload="auto";
  let actx, analyser, data, playing=false;
  function ensureAudio(){
    if(actx) return;
    actx = new (window.AudioContext||window.webkitAudioContext)();
    const src = actx.createMediaElementSource(audio);
    analyser = actx.createAnalyser(); analyser.fftSize=256;
    data = new Uint8Array(analyser.frequencyBinCount);
    src.connect(analyser); analyser.connect(actx.destination);
  }
  function naturalSort(a,b){ return a.name.localeCompare(b.name,'ja',{numeric:true}); }
  document.getElementById('audDir').addEventListener('change', e=>{
    ensureAudio();
    audList = [...e.target.files].filter(f=>f.type.startsWith('audio/')).sort(naturalSort);
    audIdx=0; if(audList.length) playIndex(audIdx);
  });
  async function playIndex(i){
    if(!audList.length) return;
    audio.src = URL.createObjectURL(audList[i]);
    try{ if(actx.state!=="running") await actx.resume(); await audio.play(); playing=true; }catch(e){}
  }
  document.getElementById('next').addEventListener('click',()=>{ if(!audList.length)return; audIdx=(audIdx+1)%audList.length; playIndex(audIdx); });
  document.getElementById('prev').addEventListener('click',()=>{ if(!audList.length)return; audIdx=(audIdx-1+audList.length)%audList.length; playIndex(audIdx); });
  document.getElementById('play').addEventListener('click', async ()=>{
    ensureAudio(); if(actx.state!=="running") await actx.resume();
    if(audio.paused){ await audio.play(); playing=true; } else { audio.pause(); playing=false; }
  });

  // ===== Canvas sizing =====
  const dprCap=1.2;
  function fit(){
    const s=Math.min(stage.clientWidth, stage.clientHeight);
    const dpr=Math.min(window.devicePixelRatio||1, dprCap);
    cv.width=cv.height=Math.max(300,Math.floor(s*dpr));
  }
  const ro=new ResizeObserver(()=>fit()); ro.observe(stage); fit();
  let lastDPR=window.devicePixelRatio; setInterval(()=>{ if(window.devicePixelRatio!==lastDPR){ lastDPR=window.devicePixelRatio; fit(); } }, 600);

  // ===== Render: silk orbits =====
  let t=0;
  function draw(){
    const w=cv.width,h=cv.height; const cx=w/2, cy=h/2; const R=Math.min(w,h)/2;
    ctx.clearRect(0,0,w,h);
    ctx.fillStyle="#000"; ctx.fillRect(0,0,w,h);
    ctx.save();
    ctx.translate(cx,cy);

    // audio energy
    let low=0, mid=0, hi=0;
    if(analyser && playing){
      analyser.getByteFrequencyData(data);
      const n=data.length;
      for(let i=0;i<n;i++){
        const v=data[i]/255;
        if(i<n*0.33) low+=v; else if(i<n*0.66) mid+=v; else hi+=v;
      }
      low/=n*0.33; mid/=n*0.33; hi/=n*0.34;
    }
    const ringCount = parseInt(ringsUI.value,10);
    const softness = parseFloat(softUI.value); // 0.1..0.9

    ctx.globalCompositeOperation="lighter";
    for(let i=0;i<ringCount;i++){
      const p=i/(ringCount-1||1);
      const baseR = R*(0.1 + 0.85*p);
      const wobble = Math.sin(t*0.6 + i*0.9)*R*0.01 + mid*R*0.02;
      const r = baseR + wobble;
      const thickness = Math.max(1, R*(0.002 + softness*0.004) * (1 + hi*0.6));
      const hue = (200 + 80*p + 40*Math.sin(t*0.2+i*0.6))%360;
      const alpha = 0.08 + 0.14*(1-p) + 0.2*low;
      // draw soft ring by stacking strokes
      ctx.strokeStyle = `hsla(${hue} 90% 60% / ${alpha})`;
      for(let k=0;k<4;k++){
        ctx.lineWidth = thickness * (1 + k*0.5);
        ctx.beginPath();
        const arcJitter = 0.006 + 0.01*(1-softness);
        const start = (p*0.7 + Math.sin(t*0.3+i)*0.02) * Math.PI*2;
        const end   = start + Math.PI*2 - arcJitter;
        ctx.arc(0,0, r + k*0.5, start, end);
        ctx.stroke();
      }
    }
    ctx.globalCompositeOperation="source-over";
    ctx.restore();

    t += 0.016 + (playing? (low*0.01 + mid*0.008 + hi*0.004) : 0);
    requestAnimationFrame(draw);
  }
  requestAnimationFrame(draw);
})();
</script>
<script>
// SW
if("serviceWorker" in navigator){ navigator.serviceWorker.register("./sw.js?v=1"); }
</script>
</body>
</html>
