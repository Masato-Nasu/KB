<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
  <title>KaleidoBaby Visualizer — Gradient Click (Big Pattern)</title>
  <link rel="manifest" href="./manifest.json">
  <link rel="icon" href="./babyface-192.png" type="image/png">
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="./babyface-192.png">
  <style>
    html, body { height: 100%; overflow: hidden; }
    body {
      margin: 0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      background: linear-gradient(45deg, #000000, #111111);
      background-size: 200% 200%;
      transition: background 2.5s ease;
    }
    body.gradient {
      background-position: 100% 0%;
    }
    canvas {
      background: transparent;
      width: 100%; max-width: 520px; aspect-ratio: 1/1;
      border-radius: 10px; opacity: 0; transition: opacity .8s ease; pointer-events: none;
    }
    canvas.active { opacity: 1; pointer-events: auto; }
    #controls {
      display: flex; flex-direction: column; align-items: stretch;
      width: 100%; max-width: 520px; margin-top: 16px; gap: 8px;
    }
    #lcd, button, label {
      height: 48px; background: #111; border: 1px solid #444; color: #fff;
      font-size: 16px; border-radius: 10px; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
    }
    #lcd span { animation: scroll 12s linear infinite; display: inline-block; white-space: nowrap; }
    @keyframes scroll { from{transform:translateX(100%);}to{transform:translateX(-100%);} }
    input[type="file"]{display:none;}
    audio{display:none;}
  </style>
</head>
<body>
  <canvas id="canvas"></canvas>

  <div id="controls">
    <div id="lcd"><span>NO FILES LOADED</span></div>
    <label id="folderButton">SELECT MUSIC FOLDER / FILES</label>
    <button id="playButton">PLAY</button>
    <button id="pauseButton">PAUSE</button>
    <button id="skipButton">NEXT</button>
    <button id="backButton">PREVIOUS</button>
    <input type="file" id="audioInput" accept="audio/*" multiple webkitdirectory>
  </div>

  <audio id="player" preload="metadata" playsinline></audio>
  <audio id="chime" src="./Sparkling Chime Sound.m4a" preload="auto"></audio>

  <script src="https://cdn.jsdelivr.net/npm/meyda/dist/web/meyda.min.js"></script>
  <script>
  const canvas=document.getElementById('canvas'),ctx=canvas.getContext('2d');
  const size=500; canvas.width=canvas.height=size;
  const imageData=ctx.createImageData(size,size);
  const CFG={
    baseF:0.020, baseK:0.045,
    quietThreshold:0.10, quietHoldMs:400,
    levelFeedGain:0.0025, levelKillGain:0.0022, paramSlew:0.10,
    spreadBase:0.90, spreadAdd:0.08,
    duVar:0.05, dvVar:0.05,
    kToneMin:2.6, kToneRange:1.0,
    whiteTint:0.20, whiteLevel:242,
    transitionMs:2600,
    clickFlashFeed:0.010, clickFlashKill:-0.005,
    clickPulseMs:200, clickPulseGain:0.45
  };

  const palette=[[156,149,246],[224,219,210],[230,175,194],[143,173,235],[111,201,191],[182,224,210]];
  let colorCurrent=[...palette[0]],colorPrev=[...palette[0]],colorTarget=[...palette[0]];
  let transitionStart=0; const lerp=(a,b,t)=>a+(b-a)*t;
  let U=new Float32Array(size*size).fill(1),V=new Float32Array(size*size).fill(0);
  for(let y=size/2-16;y<size/2+16;y++)for(let x=size/2-16;x<size/2+16;x++)V[y*size+x]=1;
  let du=0.24,dv=0.12,flashFeed=0,flashKill=0;

  function lap(f,x,y){
    return f[((y-1+size)%size)*size+x]+f[((y+1)%size)*size+x]+
           f[y*size+((x-1+size)%size)]+f[y*size+((x+1)%size)]-4*f[y*size+x];
  }

  // 放射対称（6分割）で大きめの面を作る
  function enforceSym(U,V){
    const half=size>>1;
    for(let y=0;y<half;y++)for(let x=0;x<half;x++){
      const sx=size-1-x,sy=size-1-y,rx=y,ry=x;
      const a=y*size+x,b=y*size+sx,c=sy*size+x,d=sy*size+sx,e=ry*size+rx,f=rx*size+ry;
      const u=(U[a]+U[b]+U[c]+U[d]+U[e]+U[f])/6, v=(V[a]+V[b]+V[c]+V[d]+V[e]+V[f])/6;
      U[a]=U[b]=U[c]=U[d]=U[e]=U[f]=u; V[a]=V[b]=V[c]=V[d]=V[e]=V[f]=v;
    }
  }

  const audio={levelSmooth:0,lastLoudAt:performance.now()};
  let feedMod=0,killMod=0;
  const clamp01=x=>Math.max(0,Math.min(1,x));

  function step(active=true){
    if(!active)return;
    const U2=new Float32Array(U.length),V2=new Float32Array(V.length);
    const lvl=audio.levelSmooth;
    const targetFeed=flashFeed+lvl*CFG.levelFeedGain;
    const targetKill=flashKill+lvl*CFG.levelKillGain;
    feedMod+=(targetFeed-feedMod)*CFG.paramSlew;
    killMod+=(targetKill-killMod)*CFG.paramSlew;
    const f=CFG.baseF+feedMod,k=CFG.baseK+killMod;
    const duNow=du*(1+lvl*CFG.duVar),dvNow=dv*(1+lvl*CFG.dvVar);
    flashFeed*=0.92; flashKill*=0.92;
    for(let i=0;i<U.length;i++){
      const y=(i/size)|0,x=i%size,u=U[i],v=V[i];
      const Lu=lap(U,x,y),Lv=lap(V,x,y);
      U2[i]=u+(duNow*Lu - u*v*v + f*(1-u));
      V2[i]=v+(dvNow*Lv + u*v*v - (f+k)*v);
    }
    enforceSym(U2,V2);U=U2;V=V2;
  }

  let clickPulseUntil=0;
  function draw(){
    const d=imageData.data,now=performance.now();
    const pulseBoost=now<clickPulseUntil?CFG.clickPulseGain:0;
    const kToneBase=CFG.kToneMin+audio.levelSmooth*CFG.kToneRange;
    const kTone=kToneBase*(1+pulseBoost);
    const norm=x=>Math.max(0,Math.min(1,x));
    const tone=x=>Math.pow((1-Math.exp(-kTone*x))/(1-Math.exp(-kTone)),1.15); // 少しだけ立体感
    const progress=Math.min(1,(now-transitionStart)/CFG.transitionMs);
    for(let i=0;i<3;i++)colorCurrent[i]=lerp(colorPrev[i],colorTarget[i],progress);
    for(let i=0;i<U.length;i++){
      const base=norm((U[i]-V[i])*1.0),t=tone(base);
      const c=(Math.min(t,0.985)*255)|0,p=i*4;
      if(c>=CFG.whiteLevel){
        const tint=CFG.whiteTint;
        d[p]=(1-tint)*255+tint*colorCurrent[0];
        d[p+1]=(1-tint)*255+tint*colorCurrent[1];
        d[p+2]=(1-tint)*255+tint*colorCurrent[2];
      }else{
        const td=1-(c/255);
        d[p]=(1-td)*255+td*colorCurrent[0];
        d[p+1]=(1-td)*255+td*colorCurrent[1];
        d[p+2]=(1-td)*255+td*colorCurrent[2];
      }
      d[p+3]=255;
    }
    ctx.putImageData(imageData,0,0);
  }

  (function loop(){
    const now=performance.now(),active=(now-audio.lastLoudAt)<CFG.quietHoldMs;
    step(active);draw();requestAnimationFrame(loop);
  })();

  function pickRandomDifferent(rgb){let n;do{n=palette[(Math.random()*palette.length)|0];}while(n[0]===rgb[0]&&n[1]===rgb[1]&&n[2]===rgb[2]);return[...n];}
  function changeColorRandom(){colorPrev=[...colorCurrent];colorTarget=pickRandomDifferent(colorTarget);transitionStart=performance.now();}
  function triggerFlashPulse(){flashFeed+=CFG.clickFlashFeed;flashKill+=CFG.clickFlashKill;clickPulseUntil=performance.now()+CFG.clickPulseMs;if('vibrate'in navigator)navigator.vibrate(20);}
  function playChime(){const c=document.getElementById('chime');if(!c)return;c.currentTime=0;c.play().catch(()=>{});}

  // クリックでグラデ背景遷移
  canvas.addEventListener('click',()=>{
    changeColorRandom();triggerFlashPulse();playChime();
    const body=document.body;
    body.style.background=`linear-gradient(45deg, rgb(${colorCurrent.join(',')}), rgb(${colorTarget.join(',')}))`;
    body.classList.toggle('gradient');
  });

  /* シェイク */
  let lastShake=0;
  function onMotion(e){
    const a=e.accelerationIncludingGravity||{x:0,y:0,z:0};
    const jerk=Math.sqrt(a.x*a.x+a.y*a.y+a.z*a.z);
    const threshold=18,cooldown=800;
    if(jerk>threshold){
      const now=performance.now();
      if(now-lastShake>cooldown){lastShake=now;changeColorRandom();triggerFlashPulse();}
    }
  }
  async function tryEnableMotion(){
    if(typeof DeviceMotionEvent!=='undefined'&&typeof DeviceMotionEvent.requestPermission==='function'){
      const r=await DeviceMotionEvent.requestPermission();if(r!=='granted')return;
    }
    window.addEventListener('devicemotion',onMotion,{passive:true});
  }
  ['click','touchstart','pointerdown','keydown'].forEach(ev=>{
    window.addEventListener(ev,function once(){tryEnableMotion();window.removeEventListener(ev,once);},{once:true});
  });

  /* Audio + UI（簡略だが動作同等） */
  const player=document.getElementById('player');
  let audioCtx,mediaSrc,analyser,meydaAnalyzer;
  function ensureGraph(){
    if(audioCtx)return;
    audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    mediaSrc=audioCtx.createMediaElementSource(player);
    analyser=audioCtx.createAnalyser();analyser.fftSize=1024;
    mediaSrc.connect(analyser);analyser.connect(audioCtx.destination);
    meydaAnalyzer=Meyda.createMeydaAnalyzer({
      audioContext:audioCtx,source:analyser,bufferSize:512,featureExtractors:['rms'],
      callback:({rms})=>{
        if(!isFinite(rms))rms=0;
        const a=0.14; const ema=(1-a)*(window._ema||0)+a*rms; window._ema=ema;
        audio.levelSmooth=(1-0.10)*(audio.levelSmooth||0)+0.10*rms;
        if(audio.levelSmooth>=CFG.quietThreshold)audio.lastLoudAt=performance.now();
      }
    });
    try{meydaAnalyzer.start();}catch{}
  }

  let playlist=[],urls=[],current=0;
  const lcdSpan=document.querySelector('#lcd span');
  const lcd=t=>lcdSpan.textContent=t;
  function sortNumeric(files){return files.sort((a,b)=>a.name.localeCompare(b.name,'ja',{numeric:true}));}
  async function replacePlaylist(files){urls=files.map(f=>URL.createObjectURL(f));playlist=sortNumeric(files);current=0;lcd(`LOADED ${files.length} files`);}
  async function play(index=current){
    if(!playlist.length)return;
    current=Math.max(0,Math.min(index,playlist.length-1));
    if(player.src!==urls[current])player.src=urls[current];
    await player.play();ensureGraph();
    if(!canvas.classList.contains('active'))canvas.classList.add('active');
    lcd(`TRACK ${current+1}/${playlist.length}: ${playlist[current].name}`);
  }
  function pauseManual(){player.pause();lcd('PAUSED');}
  player.addEventListener('ended',()=>play((current+1)%playlist.length));
  document.getElementById('playButton').addEventListener('click',()=>play(current));
  document.getElementById('pauseButton').addEventListener('click',pauseManual);
  document.getElementById('skipButton').addEventListener('click',()=>play((current+1)%playlist.length));
  document.getElementById('backButton').addEventListener('click',()=>play((current-1+playlist.length)%playlist.length));

  const folderButton=document.getElementById('folderButton');
  const audioInput=document.getElementById('audioInput');
  folderButton.addEventListener('click',async(e)=>{
    e.preventDefault();
    if('showDirectoryPicker'in window){
      const h=await window.showDirectoryPicker({mode:'read'});
      const files=[];async function*walk(h){for await(const[n,e]of h.entries()){if(e.kind==='file')yield await e.getFile();else if(e.kind==='directory')yield*walk(e);}}
      for await(const f of walk(h))files.push(f);
      await replacePlaylist(files,h.name);
    }else audioInput.click();
  });
  audioInput.addEventListener('change',async(e)=>{await replacePlaylist([...e.target.files||[]]);});

  if('serviceWorker'in navigator){
    window.addEventListener('load',()=>navigator.serviceWorker.register('./sw.js').catch(()=>{}));
  }
  </script>
</body>
</html>
