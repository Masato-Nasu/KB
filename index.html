<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Square Kaleidoscope ‚Äî PWA + Chime</title>

<link rel="manifest" href="./manifest.json?v=2">
<meta name="theme-color" content="#0f0f12">
<link rel="icon" href="./icon-192.png">
<link rel="apple-touch-icon" href="./icon-192.png">

<style>
  html,body{margin:0;height:100%;background:#000;overflow:hidden}
  #c{width:100vw;height:100vh;display:block;touch-action:manipulation}
  #ui{position:fixed;bottom:10px;left:50%;transform:translateX(-50%);
      display:flex;gap:10px;align-items:center;color:#fff;font-family:sans-serif;font-size:14px;flex-wrap:wrap;justify-content:center;z-index:3}
  input[type=file]{display:none}
  label,button{background:#111;border:1px solid #444;border-radius:8px;padding:8px 14px;cursor:pointer;color:#fff}
  #status{position:fixed;top:10px;left:50%;transform:translateX(-50%);color:#9cf;font-family:monospace;font-size:12px;opacity:.95;z-index:3}
  #install{position:fixed;top:10px;right:10px}
</style>
</head>
<body>
<canvas id="c"></canvas>
<div id="status">booting‚Ä¶</div>

<div id="ui">
  <label>ÁîªÂÉèÈÅ∏Êäû<input type="file" id="img" accept="image/*"></label>
  <button id="reset">ÁîªÂÉè„ÇØ„É™„Ç¢</button>
  <button id="enable">üîä „Çª„É≥„Çµ„Éº„Å®Èü≥„ÇíÊúâÂäπÂåñ</button>
  <button id="install" hidden>+ „Ç§„É≥„Çπ„Éà„Éº„É´</button>
</div>

<script>
/* ===== SW ===== */
if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js?v=2');

/* ===== PWA Install ===== */
let deferredPrompt;
const installBtn = document.getElementById('install');
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault(); deferredPrompt=e; installBtn.hidden=false;
});
installBtn.onclick = async () => {
  installBtn.hidden=true; if(deferredPrompt){ deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; }
};

/* ===== Canvas ===== */
const canvas = document.getElementById('c'), statusEl = document.getElementById('status');
const dpr=Math.min(devicePixelRatio||1,2);
function fit(){ canvas.width=Math.floor(innerWidth*dpr); canvas.height=Math.floor(innerHeight*dpr); }
addEventListener('resize', fit); fit();
const ctx2d = canvas.getContext('2d');
function drawChecker2D(){
  const w=canvas.width,h=canvas.height,c=16,s=Math.ceil(Math.min(w,h)/c);
  for(let y=0;y<Math.ceil(h/s);y++)for(let x=0;x<Math.ceil(w/s);x++){
    ctx2d.fillStyle=((x+y)&1)?'#202020':'#505050'; ctx2d.fillRect(x*s,y*s,s,s);
  }
}
drawChecker2D(); statusEl.textContent='2D checker ‚Äî WebGL ÂàùÊúüÂåñ‰∏≠‚Ä¶';

/* ===== WebGL ===== */
let gl, prog, tex=null, start=performance.now(), hasTex=0.0;
function initGL(){
  gl = canvas.getContext('webgl',{alpha:false,antialias:true});
  if(!gl) throw new Error('WebGL ÁÑ°Âäπ');
  const vs=`attribute vec2 aPos;varying vec2 vUv;void main(){vUv=(aPos+1.0)*0.5;gl_Position=vec4(aPos,0.0,1.0);}`;
  const fs=`precision mediump float;varying vec2 vUv;uniform float uTime,uSectors,uHasTex;uniform sampler2D uTex;
  vec3 checker(vec2 uv){float s=16.0;vec2 c=floor(uv*s);float m=mod(c.x+c.y,2.0);float v=mix(0.32,0.10,m);return vec3(v);}
  void main(){vec2 uv=vUv-0.5;float r=length(uv);float a=atan(uv.y,uv.x);a=mod(a*uSectors/2.0,3.14159265358979323846264);
  vec2 p=vec2(cos(a),sin(a))*r;float breathe=1.0+0.25*sin(uTime*0.8);vec2 t=p*breathe+0.5;
  vec3 col=(uHasTex>0.5)?texture2D(uTex,t).rgb:checker(t);gl_FragColor=vec4(col,1.0);}`;
  function sh(tp,src){const s=gl.createShader(tp);gl.shaderSource(s,src);gl.compileShader(s);
    if(!gl.getShaderParameter(s,gl.COMPILE_STATUS)) throw new Error(gl.getShaderInfoLog(s)); return s;}
  const vsObj=sh(gl.VERTEX_SHADER,vs), fsObj=sh(gl.FRAGMENT_SHADER,fs);
  prog=gl.createProgram(); gl.attachShader(prog,vsObj); gl.attachShader(prog,fsObj); gl.linkProgram(prog);
  if(!gl.getProgramParameter(prog,gl.LINK_STATUS)) throw new Error(gl.getProgramInfoLog(prog));
  gl.useProgram(prog);
  const quad=new Float32Array([-1,-1,1,-1,-1,1,1,1]);
  const vbo=gl.createBuffer(); gl.bindBuffer(gl.ARRAY_BUFFER,vbo); gl.bufferData(gl.ARRAY_BUFFER,quad,gl.STATIC_DRAW);
  const loc=gl.getAttribLocation(prog,'aPos'); gl.enableVertexAttribArray(loc); gl.vertexAttribPointer(loc,2,gl.FLOAT,false,0,0);
  prog.uTime=gl.getUniformLocation(prog,'uTime'); prog.uSectors=gl.getUniformLocation(prog,'uSectors');
  prog.uTex=gl.getUniformLocation(prog,'uTex'); prog.uHasTex=gl.getUniformLocation(prog,'uHasTex');
  gl.uniform1f(prog.uSectors,16.0); gl.uniform1f(prog.uHasTex,0.0); gl.uniform1i(prog.uTex,0);
  gl.viewport(0,0,canvas.width,canvas.height);
  statusEl.textContent='WebGL ÂàùÊúüÂåñOK ‚Äî Êó¢ÂÆöÊ®°Êßò';
}
function makeTextureFromImage(img){
  if(!gl)return; if(!tex) tex=gl.createTexture();
  gl.activeTexture(gl.TEXTURE0); gl.bi
